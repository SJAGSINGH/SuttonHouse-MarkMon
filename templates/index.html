<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sutton House | Master Terminal</title>

  <!-- Socket.IO -->
 <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

<script>
// HARD FAIL-SOFT GUARD (GLOBAL)
window.onerror = function (msg, src, line, col, err) {
  console.error("[UI ERROR]", msg, "at", src + ":" + line + ":" + col, err);
  return true; // fail-soft
};
</script>

<script>
// GLOBAL STATE (must exist before any JS uses it)
let secretMode = false;
let founderMode = false;
</script>

  <!-- Styles -->
<style>
  :root{
    --bg:#050505; --card:#111111; --text:#ffffff;
    --dim:#333333; --lime:#32CD32; --gold:#BF953F; --silver:#C0C0C0;
    --pink:#FF69B4; --red:#ff4444; --orange:#ff8c00;

    --secret:#1fa67a;
    --secret-bg-1:#0b1512;
    --secret-bg-2:#0f2a21;

    --war-1:#12080a;
    --war-2:#061313;

    --gseg-off:#1b1b1b;
    --gseg-off-b:#242424;

    /* ============================
       BLUE STEEL (Financial Asset Regime)
    ============================ */
    --steel:#4aa3ff;
    --steel-bg-1:#0b1320;
    --steel-bg-2:#0e1f36;
  }
  /* ============================
   CARD 2 — CAPITAL ROTATION
   Matches Card 1 behaviour
   ============================ */

/* ============================================================
   CARD 2 — tidy text styling (paste into <style> in index.html)
   Put this near your other card styles (e.g. after Card 1 rules)
   ============================================================ */

/* CARD 2 text treatment (matches Card 1 behaviour) */
  #card-2 .primary-text{
    color:#ffffff;
    font-weight:600;
    text-transform:uppercase;
  }

  #card-2 .secondary-text{
    margin-top:6px;
    font-size:12px;
    letter-spacing:0.04em;
    text-transform:uppercase;
  }

  /* State colours */
  .card2-green{ color: var(--lime); }
  .card2-red{ color: var(--red); }
  .card2-neutral{ color: rgba(255,255,255,0.65); }

  body{
    background:var(--bg); color:var(--text);
    font-family:Inter,system-ui,sans-serif;
    margin:0; padding:22px 40px 40px;  /* pulls header up */
    display:flex; flex-direction:column; gap:40px;
    min-height:100vh; box-sizing:border-box;
    overflow-x:hidden;
    transition:background .35s ease;
  }

  body.war-room{
    background:
      radial-gradient(1100px 700px at 15% 10%, rgba(255,68,68,.10), transparent 55%),
      radial-gradient(900px 600px at 85% 25%, rgba(31,166,122,.10), transparent 55%),
      linear-gradient(145deg, var(--war-1), var(--war-2));
  }


/* ============================
   HEADER — FINAL ALIGN (LOCKED)
============================ */

.header{
  display:grid;
  grid-template-columns: 340px 1fr 160px;  /* LEFT / CENTER / SCADA */
  align-items:center;
  border-bottom:1px solid #222;
  padding:0 0 6px;                         /* border sits higher */
  gap:18px;
  margin-top:-10px;                        /* lift the whole header slightly */
}

/* LEFT */
.logo-area{
  display:flex;
  flex-direction:column;
  align-items:center;                      /* crest centered to wordmark */
  justify-content:center;
  gap:0;
}

.logo-img{
  height:150px;
  width:auto;
  display:block;
  margin:0 0 -26px 0;                      /* pulls text closer + up */
}

.brand-stack{
  width:fit-content;                       /* stops stretching */
  text-align:center;                       /* centers SUTTON HOUSE under crest */
  margin-top:-10px;                        /* move Sutton House up a touch */
  padding:0;
}

.gleam{ margin:0; line-height:1; }

.brand-subtitle{
  margin-top:2px;
  display:flex;
  align-items:center;
  justify-content:center;
  gap:12px;
  line-height:1;
}

/* terminal line */
.brand-bottom{
  display:inline-flex;
  align-items:center;
  gap:10px;
  margin:0 !important;
  line-height:1;
}

/* CENTER */
.center-stack{
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  text-align:center;
  gap:4px;
}

/* clock */
#digital-clock{
  font-size:38px;
  font-weight:700;
  letter-spacing:-1px;
  line-height:1;
  margin:0;
}



/* cities */
/* CITY LINE — HORIZONTAL */
.city-grid{
  display:flex;
  flex-direction:row;
  justify-content:center;
  align-items:center;
  gap:14px;
  margin-top:6px;
  font-size:10px;
  letter-spacing:1.5px;
}

.city-item{
  display:flex;
  align-items:center;
  gap:6px;
  font-size:10px;
  font-weight:700;
  text-transform:uppercase;
  color:#9a9a9a;
  transition:color .25s ease;
}

/* active market */
.city-open{
  color:var(--lime) !important;
}

.city-item .status-dot{
  width:5px;
  height:5px;
  border-radius:50%;
  background:#666;
}

.city-open .status-dot{
  background:var(--lime);
  box-shadow:0 0 10px rgba(50,205,50,.8);
}


/* small comms pulse on receive */
.comms-flash{
  filter:brightness(1.35);
}


/* ============================
   SCADA MAN — seated + contained (LOCK v3)
   Fix: sits LOWER (strong seat)
   Sway: forward/back (reduced lift)
============================ */

#scada-comms{ display:none !important; }
#dbg-toggle{ display:none; }

.scada-slot{
  width:160px;
  height:160px;
  display:flex;
  align-items:center;
  justify-content:flex-end;
  pointer-events:none;
}

.scada-card{
  width:160px;
  height:160px;
  border-radius:14px;
  border:1px solid rgba(31,166,122,.18);
  background:rgba(0,0,0,.18);
  box-shadow:
    0 0 24px rgba(31,166,122,.12),
    inset 0 0 18px rgba(31,166,122,.08);
  display:flex;
  align-items:center;
  justify-content:center;
  overflow:hidden;
}

/* INNER frame */
.scada-man-wrap{
  width:142px;
  height:142px;
  border-radius:12px;
  border:1px solid rgba(31,166,122,.22);
  background:rgba(0,0,0,.12);
  box-shadow:
    0 0 26px rgba(31,166,122,.14),
    inset 0 0 20px rgba(31,166,122,.10);

  /* SEAT HIM HARDER */
  display:flex;
  align-items:flex-end;
  justify-content:center;
  padding-bottom:18px;          /* was 10 */
  overflow:hidden;

  /* forward/back sway */
  transform-origin:50% 94%;
  animation:scada-sway-fb 7.6s ease-in-out infinite;
}

.scada-man{
  width:118px;
  height:auto;
  display:block;
  object-fit:contain;

  /* FINAL seat nudge */
  margin:0 auto;
  transform: translateY(16px);  /* was 6 */

  filter:
    drop-shadow(0 0 14px rgba(31,166,122,.22))
    drop-shadow(0 0 28px rgba(31,166,122,.12));
  opacity:.96;
}

/* forward/back sway — reduced lift so he doesn't climb */
@keyframes scada-sway-fb{
  0%   { transform: translateY(0px) scale(1); }
  50%  { transform: translateY(-1px) scale(1.012); }
  100% { transform: translateY(0px) scale(1); }
}

body.war-room .scada-card{
  box-shadow:
    0 0 30px rgba(31,166,122,.16),
    inset 0 0 20px rgba(31,166,122,.10);
}







/* kill old rail classes if still present */
.right-rail,
.right-stack{ display:contents !important; }


  .gleam{
    font-weight:800; font-size:32px; letter-spacing:3px; margin:0;
    background:linear-gradient(to right,#BF953F 0%,#FCF6BA 25%,#B38728 50%,#FBF5B7 75%,#AA771C 100%);
    background-size:200% auto;
    -webkit-background-clip:text; -webkit-text-fill-color:transparent;
    animation:shine 5s linear infinite;
  }
  @keyframes shine{ to { background-position:200% center; } }

  .brand-bottom{
    display:flex; align-items:center; gap:10px; margin-top:5px;
    color:#fff; font-size:11px; text-transform:uppercase;
    letter-spacing:1.5px; font-weight:300;
  }
  .status-dot-active{
    width:5px; height:5px; border-radius:50%;
    background:var(--lime); box-shadow:0 0 10px var(--lime);
    animation:pulse-lime 2s infinite;
  }
  @keyframes pulse-lime{ 0%{opacity:1} 50%{opacity:.4} 100%{opacity:1} }



  .macro-header{
    font-size:14px; font-weight:700; color:#555;
    text-transform:uppercase; letter-spacing:4px;
    margin-bottom:-20px; border-left:3px solid var(--gold); padding-left:15px;
    display:flex; align-items:center; justify-content:space-between; gap:18px;
  }
  #scada-comms.flash {
    color: var(--lime);
    text-shadow: 0 0 12px rgba(50,205,50,.25);
    transition: .08s;
  }

  /* Public teaser badge (shows only when war.active=true and NOT in secret mode) */
  #war-badge{
    display:none;
    font-size:10px;
    letter-spacing:2px;
    text-transform:uppercase;
    color:var(--red);
    border:1px solid rgba(255,68,68,.35);
    background:rgba(0,0,0,.25);
    padding:7px 10px;
    border-radius:999px;
    white-space:nowrap;
    user-select:none;
  }

  .grid{ display:grid; grid-template-columns:repeat(4,1fr); gap:20px; }
  .card{
    background:var(--card); padding:35px; border-radius:8px;
    border:1px solid #1f1f1f;
    transition:all .6s cubic-bezier(0.4,0,0.2,1);
    display:flex; flex-direction:column;
    position:relative;
    min-height:170px;
  }
  .card h3{
    font-size:10px; color:#555; text-transform:uppercase;
    margin:0 0 20px 0; letter-spacing:2px;
  }
  .primary-text{
    font-size:19px; font-weight:800; color:#fff; text-transform:uppercase;
    display:flex; align-items:center; gap:10px;
  }
  .secondary-text{
    font-size:11px; font-weight:700; margin-top:8px;
    text-transform:uppercase; letter-spacing:1px;
  }

  .halo-bg-gold{
    border-color: var(--gold) !important;
    background: linear-gradient(145deg, #111111 0%, #2a2210 100%) !important;
    box-shadow: 0 0 30px rgba(191,149,63,.15), inset 0 0 20px rgba(191,149,63,.10);
  }
  .halo-bg-silver{
    border-color: var(--silver) !important;
    background: linear-gradient(145deg, #111111 0%, #1a1a1a 100%) !important;
    box-shadow: 0 0 30px rgba(192,192,192,.15), inset 0 0 20px rgba(192,192,192,.08);
  }

  /* ============================
     BLUE STEEL (Financial Asset Regime)
  ============================ */
  .halo-bg-steel{
    border-color: var(--steel) !important;
    background: linear-gradient(145deg, var(--steel-bg-1) 0%, var(--steel-bg-2) 100%) !important;
    box-shadow: 0 0 30px rgba(74,163,255,.14), inset 0 0 22px rgba(74,163,255,.10);
  }

  /* Optional Founder haze overlays (safe to leave even if unused for now) */
  .haze-steel{
    box-shadow:
      0 0 40px rgba(74,163,255,.10),
      inset 0 0 28px rgba(74,163,255,.08) !important;
  }
  .haze-gold{
    box-shadow:
      0 0 40px rgba(191,149,63,.10),
      inset 0 0 28px rgba(191,149,63,.08) !important;
  }

  .glow-lime{
    border-color: var(--lime) !important;
    background: linear-gradient(145deg, #111111 0%, #0a1f0a 100%) !important;
    box-shadow: 0 0 26px rgba(50,205,50,.12), inset 0 0 22px rgba(50,205,50,.10);
  }
  .glow-warning{
    border-color: var(--orange) !important;
    background: linear-gradient(145deg, #111111 0%, #2a1a0a 100%) !important;
    box-shadow: 0 0 26px rgba(255,140,0,.12), inset 0 0 22px rgba(255,140,0,.10);
  }
  .glow-danger{
    border-color: var(--red) !important;
    background: linear-gradient(145deg, #111111 0%, #2a0a0a 100%) !important;
    box-shadow: 0 0 26px rgba(255,68,68,.14), inset 0 0 22px rgba(255,68,68,.12);
  }

  .halo-bg-secret{
    border-color: var(--secret) !important;
    background: linear-gradient(145deg, var(--secret-bg-1) 0%, var(--secret-bg-2) 100%) !important;
    box-shadow: 0 0 34px rgba(31,166,122,.22), inset 0 0 26px rgba(31,166,122,.18);
  }

  .track{ width:100%; height:4px; background:#1a1a1a; margin-top:18px; border-radius:2px; overflow:hidden; display:none; }
  .fill{ height:100%; width:0%; transition:1.2s; background:var(--gold); }

  .pulse-container{ display:flex; justify-content:center; align-items:center; padding:15px 0; flex-grow:1; }
  .pulse-node{ width:55px; height:55px; border-radius:50%; background:var(--dim); transition:.4s; }
  .pulse-slow{ animation:node-pulse 3s infinite ease-in-out; }
  .pulse-mid{ animation:node-pulse 1.2s infinite ease-in-out; }
  .pulse-fast{ animation:node-pulse .5s infinite ease-in-out; }
  @keyframes node-pulse{ 0%{transform:scale(.9);opacity:.5} 50%{transform:scale(1.1);opacity:1} 100%{transform:scale(.9);opacity:.5} }
  .recession-text{ font-size:12px !important; text-align:center; justify-content:center; margin-top:10px; }

  #password-modal{
    display:none; position:fixed; top:0; left:0; width:100%; height:100%;
    background:rgba(0,0,0,.95); z-index:10000;
    justify-content:center; align-items:center;
  }
  .modal-content{ background:#111; padding:30px; border:1px solid var(--gold); border-radius:4px; text-align:center; }
  .modal-input{
    background:#000; border:1px solid #333; color:#fff;
    padding:10px; width:200px; text-align:center;
    margin-bottom:20px; outline:none; font-family:monospace; letter-spacing:4px;
  }

  #vault-exit{
    display:none;
    margin-top:18px;
    padding:10px 14px;
    background:rgba(0,0,0,.25);
    border:1px solid rgba(31,166,122,.55);
    color:var(--secret);
    font-size:10px;
    letter-spacing:2px;
    text-transform:uppercase;
    cursor:pointer;
    border-radius:6px;
    width:fit-content;
    align-self:flex-start;
    transition:all .25s ease;
  }
  #vault-exit:hover{
    background:rgba(31,166,122,.08);
    box-shadow:0 0 18px rgba(31,166,122,.18);
  }

  /* Gauges */
  .gauge{
    margin-top:14px;
    display:flex;
    gap:10px;
    align-items:center;
  }
  .gauge-title{
    font-size:10px;
    color:#8a8a8a;
    letter-spacing:2px;
    text-transform:uppercase;
    min-width:120px;
    user-select:none;
  }
  .gauge-bars{
    display:grid;
    grid-template-columns:repeat(10, 1fr);
    gap:5px;
    width:100%;
  }
  .gseg{
    height:10px;
    border-radius:3px;
    background:var(--gseg-off);
    border:1px solid var(--gseg-off-b);
    transition:.25s;
  }
  .gmeta{
    margin-top:10px;
    font-size:10px;
    color:#8a8a8a;
    letter-spacing:1.4px;
    text-transform:uppercase;
    line-height:1.4;
  }
  .gmeta strong{ color:#fff; letter-spacing:1.2px; }

  /* ============================
     MONITORING STATE CARD
  ============================ */
  .section-header{
    font-size:14px; font-weight:700; color:#555;
    text-transform:uppercase; letter-spacing:4px;
    margin-bottom:-20px;
    border-left:3px solid var(--gold);
    padding-left:15px;
  }

  .card-wide{
    grid-column:1 / -1;
    min-height:180px;
  }

  .badge-row{
    display:flex;
    flex-wrap:wrap;
    gap:10px;
    margin-top:16px;
  }

  .badge{
    font-size:10px;
    letter-spacing:2px;
    text-transform:uppercase;
    padding:7px 12px;
    border-radius:999px;
    border:1px solid #2a2a2a;
    background:#0b0b0b;
    color:#cfcfcf;
  }

  .badge-good{
    border-color:rgba(50,205,50,.45);
    color:var(--lime);
  }
  .badge-warn{
    border-color:rgba(255,140,0,.45);
    color:var(--orange);
  }
  .badge-bad{
    border-color:rgba(255,68,68,.45);
    color:var(--red);
  }
 

  .mono{
    font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
  }
</style>

</head>

<body>
  


  <header class="header">

  <!-- LEFT: Crest + Brand -->
  <div class="logo-area">
    <img src="/static/logo.png" class="logo-img" alt="Logo" />

    <div class="brand-stack">
      <h1 class="gleam">SUTTON HOUSE</h1>
      <div class="brand-subtitle">
        MARKET ANALYTICS
        <span class="brand-bottom" id="terminal-line">
          <span class="status-dot-active" id="term-dot"></span>
          <span class="terminal-active" id="term-text">TERMINAL ACTIVE</span>
        </span>
      </div>
    </div>
  </div>

  <!-- CENTER: Clock + Cities -->
  <div class="center-stack">
    <div id="digital-clock">00:00:00</div>

    <div class="city-grid">
      <div class="city-item" id="city-lon"><div class="status-dot"></div>LONDON</div>
      <div class="city-item" id="city-ny"><div class="status-dot"></div>NEW YORK</div>
      <div class="city-item" id="city-tor"><div class="status-dot"></div>TORONTO</div>
      <div class="city-item" id="city-syd"><div class="status-dot"></div>SYDNEY</div>
    </div>

    <!-- Hidden comms (JS integrity) -->
    <div id="scada-comms" class="mono scada-comms-hidden">
      <span id="scada-age">AGE: —</span>
      <span id="scada-source">SOURCE: —</span>
      <span id="scada-last">LAST: —</span>
    </div>

    <button id="dbg-toggle" class="dbg-btn">DEBUG</button>
  </div>

  <!-- RIGHT: SCADA Man -->
<div class="scada-slot">
  <div class="scada-card" aria-hidden="true">
    <div class="scada-man-wrap">
      <img src="/static/SCADA_Man.png" class="scada-man" alt="" />
    </div>
  </div>
</div>


</header>




  <div class="macro-header">
    <div>Macro Analysis</div>
    <div id="war-badge">WAR SIGNAL DETECTED — SECURE LAYER REQUIRED</div>
  </div>

  <button id="vault-exit" onclick="closeVault()">← Exit Secure Layer</button>

  <main class="grid">
    <div class="card" id="card-1">
      <h3 id="h3-1">Regime &amp; Volatility</h3>
      <div class="primary-text" id="val-1">AWAITING</div>
      <div class="secondary-text" id="sub-1"></div>
      <div id="gauge-1" style="display:none;"></div>
    </div>

    <div class="card" id="card-2">
      <h3>CAPITAL ROTATION</h3>

      <!-- Main headline (white, big, same as others) -->
      <div class="primary-text" id="val-2">
        SHORT-TERM PREFERENCE REMAINS
      </div>

      <!-- Status line (small, coloured, secondary) -->
      <div class="secondary-text card2-neutral" id="val-2b">
        UNCLEAR — MONITORING
      </div>
    </div>



    <div class="card" id="card-3">
      <h3 id="h3-3">CYCLE CLOCK</h3>
      <div class="primary-text" id="val-3">AWAITING</div>
      <div class="secondary-text" id="sub-3"></div>
      <div class="track" id="track-3"><div class="fill" id="fill-3"></div></div>
      <div id="gauge-3" style="display:none;"></div>
    </div>
    
   <div class="card" id="card-4">
  <h3>Recession Pulse</h3>

  <!-- Pulse node -->
  <div class="pulse-container">
    <div id="led-node" class="pulse-node"></div>
  </div>

  <!-- Market Weakness (ONLY shown during Contraction) -->
  <div class="mw-wrap" id="mw-wrap" style="display:none;">
    <div class="mw-row">
      <div class="mw-title">MARKET WEAKNESS</div>
      <div class="mw-val" id="mw-val">—</div>
    </div>

    <div class="mw-bar" aria-hidden="true">
      <div class="mw-fill" id="mw-fill"></div>
      <div class="mw-capline"></div>
      <div class="mw-caplabel">35%</div>
    </div>

    <div class="mw-note" id="mw-note" style="display:none;">
      MARKET WEAKNESS THRESHOLD ACHIEVED
    </div>
  </div>

  <!-- Sahm state text -->
  <div class="primary-text recession-text" id="val-4">AWAITING</div>
  <div class="secondary-text" id="sub-4" style="display:none;"></div>
</div>

  </main>

  <div class="section-header">Message System</div>

<main class="grid">
  <div class="card card-wide" id="msg-card">
    <h3>Behaviour Governor</h3>

    <div class="primary-text" id="msg-headline">WAITING</div>
    <div class="secondary-text" id="msg-subline">AWAITING — NO ACTIVE CONDITION</div>

    <div class="badge-row">
      <div class="badge" id="msg-regime">WAITING — REGIME</div>
      <div class="badge" id="msg-setup">WAITING — SETUP</div>
      <div class="badge" id="msg-signal">WAITING — SIGNAL</div>
      <div class="badge" id="msg-observe">OBSERVE: —</div>
    </div>

    <div class="gmeta" style="margin-top:16px;">
      <strong>Rule:</strong> Macro decides direction. Message decides behaviour. Waiting means no action.
    </div>
  </div>
</main>
<!-- ============================
     SCADA DEBUG PANEL (ENGINEERING INTEGRITY)
============================ -->
<div id="scada-debug" style="display:none; margin-top:20px;">
  <div class="card card-wide" style="border:1px solid #2a2a2a;">
    <h3>SCADA Debug (Handshake)</h3>

    <div class="badge-row" style="margin-top:0;">
      <div class="badge" id="dbg-socket">SOCKET: —</div>
      <div class="badge" id="dbg-last-ts">LAST TS: —</div>
      <div class="badge" id="dbg-age">AGE: —</div>
      <div class="badge" id="dbg-path">SOURCE: —</div>
    </div>

    <pre id="dbg-json" class="mono" style="margin-top:18px; font-size:12px; line-height:1.35; white-space:pre-wrap;"></pre>

    <div class="gmeta" style="margin-top:14px;">
      <strong>Purpose:</strong> Prove receive → broadcast → paint. Not an investment tool.
    </div>
  </div>
</div>

  <div id="password-modal">
    <div class="modal-content">
      <h2 style="color:var(--gold);font-size:10px;letter-spacing:3px;margin-bottom:20px;text-transform:uppercase;">Encryption Key Required</h2>
      <input type="password" id="pass-input" class="modal-input" placeholder="****" />
      <div style="display:flex;gap:10px;justify-content:center;">
        <button onclick="checkPass()" style="background:var(--gold);border:none;color:#000;padding:8px 15px;font-weight:bold;cursor:pointer;font-size:10px;">VERIFY</button>
        <button onclick="closeModal()" style="background:none;border:1px solid #333;color:#555;padding:8px 15px;cursor:pointer;font-size:10px;">ABORT</button>
      </div>
    </div>
  </div>

  <script>
  // ----------------------------
  // CLOCK
  // ----------------------------
 // Terminal line should always be visible.
// Status color/text will reflect comms freshness (OFFLINE until first timestamp).
const term = document.getElementById('terminal-line');
if (term) term.style.display = 'inline-flex';

// default state on boot

function setTerminalStatus(mode){
  const dot  = document.getElementById('term-dot');
  const text = document.getElementById('term-text');
  if (!dot || !text) return;

  // reset
  dot.style.boxShadow = '';
  dot.style.background = '';
  text.style.color = '';

  if (mode === 'OK'){
    dot.style.background = 'var(--lime)';
    dot.style.boxShadow = '0 0 10px var(--lime)';
    text.textContent = 'TERMINAL ACTIVE';
    text.style.color = 'var(--lime)';
    return;
  }

  if (mode === 'WARN'){
    dot.style.background = 'var(--orange)';
    dot.style.boxShadow = '0 0 10px var(--orange)';
    text.textContent = 'TERMINAL STALE';
    text.style.color = 'var(--orange)';
    return;
  }

  // OFFLINE (default)
  dot.style.background = 'var(--red)';
  dot.style.boxShadow = '0 0 10px var(--red)';
  text.textContent = 'TERMINAL OFFLINE';
  text.style.color = 'var(--red)';
}
    
setTerminalStatus('OFFLINE');

  function tick(){
    const now = new Date();
    const clock = document.getElementById('digital-clock');
    if (clock) clock.innerText = now.toLocaleTimeString('en-GB', {hour12:false});

    const hrs = now.getUTCHours();
    const setCity = (id, open) => {
      const el = document.getElementById(id);
      if (el) el.className = open ? 'city-item city-open' : 'city-item';
    };

    setCity('city-lon', hrs >= 8 && hrs < 16);
    setCity('city-ny',  hrs >= 13 && hrs < 21);
    setCity('city-tor', hrs >= 13 && hrs < 21);
    setCity('city-syd', hrs >= 22 || hrs < 6);
  }
  tick();
  setInterval(tick, 1000);

  function triggerPulse(){
    document.querySelectorAll('.city-item').forEach(i => i.classList.add('comms-flash'));
    setTimeout(() => document.querySelectorAll('.city-item').forEach(i => i.classList.remove('comms-flash')), 400);
  }
 

  

  // ----------------------------
  // COLOR PALETTES (rhyme with Pine)
  // ----------------------------
  const XY_COL = { 1:'rgb(255, 6, 6)',2:'rgb(252, 72, 0)',3:'rgb(244, 106, 0)',4:'rgb(230, 135, 0)',5:'rgb(215, 159, 0)',6:'rgb(197, 181, 0)',7:'rgb(176, 200, 0)',8:'rgb(149, 219, 0)',9:'rgb(106, 238, 0)',10:'rgb(0, 255, 26)' };
  const BUY_COL = { 1:'rgb(228,250,242)',2:'rgb(175,240,217)',3:'rgb(121,230,191)',4:'rgb(67,220,165)',5:'rgb(35,188,134)',6:'rgb(25,134,95)',7:'rgb(15,80,57)',8:'rgb(5,27,19)',9:'rgb(5,27,19)',10:'rgb(5,27,19)' };
  const SELL_COL= { 1:'rgb(250,228,228)',2:'rgb(240,175,175)',3:'rgb(230,121,121)',4:'rgb(220,67,67)',5:'rgb(188,35,35)',6:'rgb(134,25,25)',7:'rgb(80,15,15)',8:'rgb(27,5,5)',9:'rgb(27,5,5)',10:'rgb(27,5,5)' };

  function clampLevel(lv){ const n = Number(lv); if (!Number.isFinite(n)) return null; return Math.max(0, Math.min(10, Math.round(n))); }
  function segStyle(color){ return `background:${color};border-color:${color};box-shadow:0 0 12px rgba(255,255,255,.06);`; }

  function mkSingleBars(level, palette){
    const lv = clampLevel(level);
    let bars = '';
    for (let i=1;i<=10;i++){
      if (lv !== null && i <= lv){
        const col = palette[i] || palette[10] || 'rgba(31,166,122,.35)';
        bars += `<div class="gseg" style="${segStyle(col)}"></div>`;
      } else {
        bars += `<div class="gseg"></div>`;
      }
    }
    return bars;
  }

  function mkDualBars(level, palette){
    const lv = clampLevel(level) || 0;
    let bars = '';
    for (let i=1;i<=10;i++){
      if (i <= lv){
        const col = palette[i] || palette[10] || 'rgba(31,166,122,.35)';
        bars += `<div class="gseg" style="${segStyle(col)}"></div>`;
      } else bars += `<div class="gseg"></div>`;
    }
    return bars;
  }

  // ----------------------------
  // STATE CACHE + helpers
  // ----------------------------
  let lastState = null;

  // ----------------------------
// SCADA DEBUG (UI)
// ----------------------------
let debugOn = false;
let debugSource = "—";
// ============================================================
// MACRO RETAIN (memory + localStorage) — SINGLE SOURCE OF TRUTH
// ============================================================
const RSC_MACRO_CACHE_KEY = "SH_MACRO_LAST_V1";

// Treat any of these as "macro present" (prevents UI resets)
function rscHasMacroFields(d){
  if (!d || typeof d !== "object") return false;
  return (
    d.cycle != null ||
    d.count != null ||
    d.vol   != null ||
    d.flow  != null ||
    d.sahm  != null ||
    d._server_ts != null
  );
}

// Save only stable macro fields (slim snapshot)
function rscSaveMacroCache(state){
  if (!state || typeof state !== "object") return;

  const slim = {
    cycle: state.cycle ?? null,
    vol:   state.vol   ?? null,
    flow:  state.flow  ?? null,
    count: state.count ?? null,
    sahm:  state.sahm  ?? null,
    spx_dd: state.spx_dd ?? null,
    dd: state.dd ?? null,
    drawdown: state.drawdown ?? null,
    spxDrawdown: state.spxDrawdown ?? null,
    spx_dd_pct: state.spx_dd_pct ?? null,
    _server_ts: state._server_ts ?? null
  };

  try{
    localStorage.setItem(RSC_MACRO_CACHE_KEY, JSON.stringify(slim));
  } catch(e){}
}

function rscLoadMacroCache(){
  try{
    const raw = localStorage.getItem(RSC_MACRO_CACHE_KEY);
    if (!raw) return null;
    const j = JSON.parse(raw);
    return (j && typeof j === "object") ? j : null;
  } catch(e){
    return null;
  }
}

// ============================================================
// PUBLIC APPLY — STABLE (no early returns, no macro wipe)
// NOTE: Card2 short-term bias is rendered in applyAllFromState,
// so Public Apply should NOT overwrite Card2 headline.
// ============================================================
function applyPublicFromState(data){

  // If this update is partial (no macro fields), reuse last macro snapshot
  if (!rscHasMacroFields(data) && rscHasMacroFields(lastState)){
    data = { ...lastState, ...data };
  }

  const warActive = !!(data?.secret?.war?.active);
  document.body.classList.toggle('war-room', warActive);
  setWarBadge(warActive);

  // ---------- reset cards ----------
  ['card-1','card-2','card-3'].forEach(id => {
    const c = document.getElementById(id);
    if (c) c.className = 'card';
  });

  // Only set AWAITING if truly missing (don't wipe if data present)
  if (data?.cycle == null) { setText('val-1','AWAITING'); setText('sub-1',''); }
  if (data?.count == null) { setText('val-3','AWAITING'); setText('sub-3',''); }
  // IMPORTANT: DO NOT touch val-2/sub-2 here (Card2 is owned elsewhere)

  const t3 = document.getElementById('track-3');
  const fill3 = document.getElementById('fill-3');
  if (t3) t3.style.display = 'none';
  if (fill3) { fill3.style.width = '0%'; fill3.style.background = 'var(--gold)'; }

  // ============================================================
  // CARD 1 — REGIME + VOL
  // ============================================================
  {
    const v1 = document.getElementById('val-1');
    const s1 = document.getElementById('sub-1');
    const c1 = document.getElementById('card-1');

    const cycleRaw = String(data?.cycle || '').trim();
    const dir = rscRegimeDirection(cycleRaw); // 'REAL' | 'FIN' | null

    if (v1){
      if (!cycleRaw) v1.innerText = 'AWAITING';
      else if (dir === 'REAL') v1.innerText = 'REAL ASSET REGIME';
      else if (dir === 'FIN')  v1.innerText = 'FINANCIAL ASSET REGIME';
      else v1.innerText = cycleRaw.toUpperCase();

      v1.style.color = 'var(--text)';
    }

    if (c1){
      c1.className = 'card';
      if (dir === 'REAL') c1.classList.add('halo-bg-gold');
      else if (dir === 'FIN') c1.classList.add('halo-bg-steel');
      else c1.classList.add('halo-bg-silver');
    }

    if (data?.vol){
      const vol = String(data.vol).toUpperCase();
      if (s1){
        s1.innerText = `VOLATILITY: ${vol}`;
        s1.style.color = (vol === 'ELEVATED') ? 'var(--red)' : 'var(--lime)';
      }
    } else {
      if (s1) { s1.innerText = ''; s1.style.color = 'var(--text)'; }
    }
  }

  // ============================================================
  // CARD 3 — CYCLE CLOCK
  // ============================================================
  {
    if (data?.count == null) return; // safe exit: Card1 already painted, Card2 handled elsewhere

    const count = rscApplyClockOffset(data.count);
    if (count === null) return;

    const v3  = document.getElementById('val-3');
    const s3  = document.getElementById('sub-3');
    const c3  = document.getElementById('card-3');
    const t3b = document.getElementById('track-3');
    const f3b = document.getElementById('fill-3');

    if (t3b) t3b.style.display = 'block';
    if (f3b) f3b.style.width = `${count}%`;
    if (s3)  s3.innerText = `MATURITY: ${count}%`;

    const stage = rscClockStage(count) || 'INITIATING';
    const dir = rscRegimeDirection(data?.cycle);
    applyFounderHaze(dir);

    let headline = `NO REGIME → ${stage}`;
    let cardClass = 'card halo-bg-silver';
    let fillCol = 'var(--silver)';

    if (dir === 'REAL'){
      headline = `REAL ASSET REGIME → ${stage}`;
      cardClass = 'card halo-bg-gold';
      fillCol = 'var(--gold)';
    } else if (dir === 'FIN'){
      headline = `FINANCIAL ASSET REGIME → ${stage}`;
      cardClass = 'card halo-bg-steel';
      fillCol = 'var(--steel)';
    }

    if (count >= 86){
      cardClass = 'card glow-danger';
      fillCol = 'var(--red)';
    } else if (count >= 71){
      cardClass = 'card glow-warning';
      fillCol = 'var(--orange)';
    }

    if (v3){
      v3.innerText = headline;
      v3.style.color = 'var(--text)';
    }
    if (c3) c3.className = cardClass;
    if (f3b) f3b.style.background = fillCol;
  }
}

// ============================================================
// STATE MERGE — accepts partial payloads without wiping macro
// ============================================================
function rscMergeIntoState(p){
  const base = (window.__RSC_LAST && typeof window.__RSC_LAST === "object") ? window.__RSC_LAST : {};
  const merged = { ...base };

  const type = String(p?.type || "").toUpperCase();

  // CARD2 payload shape (TradingView)
  if (type === "CARD2"){
    merged.card2_state = p.state ?? merged.card2_state ?? null;
    merged.card2_text  = p.text  ?? merged.card2_text  ?? null;
    merged._last_card2_ts = p.time ?? merged._last_card2_ts ?? null;
    return merged;
  }

  // MACRO or mixed payload: overlay keys
  if (p && typeof p === "object") Object.assign(merged, p);

  return merged;
}

// ============================================================
// HANDLE UPDATE — validate once, paint once, persist macro
// ============================================================
window.handleMacroUpdate = function(payload){
  let p = payload;

  // normalize server shapes
  if (p && typeof p === "object") {
    if (p.state && typeof p.state === "object") p = p.state;
    else if (p.payload && typeof p.payload === "object") p = p.payload;
    else if (p.data && typeof p.data === "object") p = p.data;
  }

  const merged = rscMergeIntoState(p);

  // validate BEFORE paint
  try{
    const v = rscValidateMacro(merged);
    if (!v.ok){
      console.warn("[RSC DROP]", v.why, merged);
      return;
    }
  } catch(e){
    console.warn("[RSC WARN] validator error, proceeding", e);
  }

  // commit
  window.__RSC_LAST = merged;

  // persist macro snapshot when present
  if (rscHasMacroFields(merged)) rscSaveMacroCache(merged);

  // paint once
  if (typeof window.applyAllFromState === "function") window.applyAllFromState(merged);
  else if (typeof applyAllFromState === "function") applyAllFromState(merged);

  console.log("[RSC HANDLE OK]", {
    cycle: merged?.cycle,
    count: merged?.count,
    sahm: merged?.sahm,
    ts: merged?._server_ts
  });
};

// ============================================================
// BOOT — paint cached macro immediately, then warmstart /health
// ============================================================
(function bootMacroCache(){
  try{
    const cached = rscLoadMacroCache();
    if (cached){
      debugSource = "boot localStorage cache";
      window.__RSC_LAST = { ...(window.__RSC_LAST || {}), ...cached };
      if (typeof window.applyAllFromState === "function") window.applyAllFromState(window.__RSC_LAST);
    }
  } catch(e){}
})();




  // ============================================================
  // ROUTE ALL LIVE DATA THROUGH ENTRY POINT
  // ============================================================
  if (socket){
   socket.on('macro_update', (data) => {
  triggerPulse();

  // Let the canonical handler normalize + paint
  if (typeof window.handleMacroUpdate === "function") window.handleMacroUpdate(data);
  else applyAllFromState(data);

  // Use the normalized last payload if available
  const p = window.__RSC_LAST || data;
  rscSetComms("socket.io macro_update", p);

  if (debugOn) refreshDebugNow();
});
    }

  // ============================================================
  // WARM START (HEALTH)
  // ============================================================
  (async function warmStart(){
    // ---- BOOT: paint cached macro instantly (if any) ----
    try{
      const cached = rscLoadMacroCache();
      if (cached){
        debugSource = "boot localStorage cache";
        // keep it in memory too
        window.__RSC_LAST = { ...(window.__RSC_LAST || {}), ...cached };
        // paint immediately
        if (typeof window.applyAllFromState === "function") window.applyAllFromState(window.__RSC_LAST);
      }
    } catch(e){}

    try{
      const r = await fetch('/health', { cache:'no-store' });
      debugSource = "warmstart /health";
      if (!r.ok) return;
      const j = await r.json();
      if (j && j.state){
         rscSetComms("warmstart /health", j.state);

        if (typeof window.handleMacroUpdate === "function") window.handleMacroUpdate(j.state);
        else applyAllFromState(j.state);
      }
    } catch(e){}
  })();

  // ============================================================
  // PASSWORD MODAL
  // ============================================================
  const tor = document.getElementById('city-tor');
  if (tor){
    tor.addEventListener('dblclick', () => {
  // If already unlocked this session, skip password prompt
  if (isFounderUnlocked()){
    enableSecretMode();
    return;
  }

  const modal = document.getElementById('password-modal');
  const input = document.getElementById('pass-input');
  if (modal) modal.style.display = 'flex';
  if (input) input.focus();
});

  }

  function closeModal(){
    const modal = document.getElementById('password-modal');
    const input = document.getElementById('pass-input');
    if (modal) modal.style.display = 'none';
    if (input) input.value = '';
  }
  window.closeModal = closeModal;

  async function checkPass(){
    const input = document.getElementById('pass-input');
    const pwd = input ? input.value : '';
    try{
      const r = await fetch('/verify_secret', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ password: pwd })
      });
      closeModal();
      if (r.ok) enableSecretMode();
    } catch(e){
      closeModal();
    }
  }
  window.checkPass = checkPass;

  const passInput = document.getElementById('pass-input');
  if (passInput){
    passInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') checkPass();
    });
  }
</script>
</body>
</html>
