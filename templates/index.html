<script>
        const socket = io();

        function tick() {
            const now = new Date();
            document.getElementById('digital-clock').innerText = now.toLocaleTimeString('en-GB', { hour12: false });
            
            const hrs = now.getUTCHours();
            document.getElementById('city-lon').className = (hrs >= 8 && hrs < 16) ? 'city-item city-open' : 'city-item';
            document.getElementById('city-ny').className = (hrs >= 13 && hrs < 21) ? 'city-item city-open' : 'city-item';
            document.getElementById('city-tor').className = (hrs >= 13 && hrs < 21) ? 'city-item city-open' : 'city-item';
            document.getElementById('city-syd').className = (hrs >= 22 || hrs < 6) ? 'city-item city-open' : 'city-item';
        }
        setInterval(tick, 1000); tick();

        function openVault() { document.getElementById('pw-overlay').style.display = 'flex'; document.getElementById('pw-input').focus(); }
        function closeVault() { document.getElementById('private-layer').style.display = 'none'; document.getElementById('pw-input').value = ""; }
        function verifyKey() { if (document.getElementById('pw-input').value === "toffees") { document.getElementById('pw-overlay').style.display = 'none'; document.getElementById('private-layer').style.display = 'block'; } }

        function triggerPulse() {
            const items = document.querySelectorAll('.city-item');
            items.forEach(i => i.classList.add('comms-flash'));
            setTimeout(() => { items.forEach(i => i.classList.remove('comms-flash')); }, 400);
        }

        socket.on("macro_update", (data) => {
            console.log("PINE ALERT RECEIVED:", data);
            triggerPulse();

            // PINE BRIDGE: Mapping "card" and "msg" to the UI
            const cardNum = data.card;
            const message = (data.msg || "").toUpperCase();

            // CARD 1: REGIME & VOLATILITY
            if (cardNum === 1) {
                const v1 = document.getElementById('val-1');
                const s1 = document.getElementById('sub-1');
                const c1 = document.getElementById('card-1');

                if (message.includes("COMMODITIES")) {
                    v1.innerHTML = 'STRONG COMMODITIES <span style="color:var(--gold)">▲</span>';
                    c1.className = "card halo-bg-gold";
                } else {
                    v1.innerHTML = 'STRONG EQUITIES <span style="color:var(--silver)">▼</span>';
                    c1.className = "card halo-bg-silver";
                }
                
                const vol = message.includes("ELEVATED") ? "ELEVATED" : "STABLE";
                s1.innerText = vol;
                s1.style.color = vol === "ELEVATED" ? "var(--red)" : "var(--lime)";
            }

            // CARD 2: CAPITAL ROTATION
            if (cardNum === 2) {
                const s2 = document.getElementById('sub-2');
                const c2 = document.getElementById('card-2');
                const isCommod = message.includes("INTO COMMODITIES");

                document.getElementById('val-2').innerText = isCommod ? "OFFENSIVE" : "DEFENSIVE";
                s2.innerText = isCommod ? "RISK-ON FLOW" : "RISK-OFF FLOW";
                s2.style.color = isCommod ? "var(--lime)" : "var(--pink)";
                c2.className = "card " + (isCommod ? "halo-bg-gold" : "halo-bg-silver");
            }

            // CARD 3: CYCLE MATURITY (The Gold Lines)
            if (cardNum === 3) {
                const v3 = document.getElementById('val-3');
                const s3 = document.getElementById('sub-3');
                const fill = document.getElementById('fill-3');
                
                // Extract number from "Month 12"
                const count = parseInt(message.replace(/[^0-9]/g, '')) || 0;
                const isStocks = document.getElementById('val-1').innerText.includes("EQUITIES");

                v3.innerText = isStocks ? "DOWN COUNT" : "UP COUNT";
                s3.innerText = count + "% CYCLE MATURITY";
                
                document.getElementById('track-3').style.display = 'block';
                fill.style.width = Math.max(count, 2) + "%";

                if (isStocks) {
                    fill.style.right = "0"; fill.style.left = "auto";
                    fill.style.background = "var(--pink)";
                    s3.style.color = "var(--pink)";
                } else {
                    fill.style.left = "0"; fill.style.right = "auto";
                    fill.style.background = count > 80 ? "var(--red)" : "var(--gold)";
                    s3.style.color = "var(--gold)";
                }
            }

            // CARD 4: RECESSION PULSE
            if (cardNum === 4) {
                const sahm = parseFloat(message.split(":")[1]) || 0;
                const c4 = document.getElementById('card-4');
                const v4 = document.getElementById('val-4');
                
                c4.classList.remove('led-pulse-red');
                if (sahm >= 0.5) {
                    v4.innerText = "CONTRACTION";
                    c4.classList.add('led-pulse-red');
                    document.getElementById('sub-4').innerText = "SAHM RULE TRIGGERED";
                } else {
                    v4.innerText = "EXPANSION";
                    document.getElementById('sub-4').innerText = "SAHM PULSE: " + sahm.toFixed(2);
                }
            }
        });
    </script>
