<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sutton House | Master Terminal</title>

  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

  <style>
    :root{
      --bg:#050505; --card:#111111; --text:#ffffff;
      --dim:#333333; --lime:#32CD32; --gold:#BF953F; --silver:#C0C0C0;
      --pink:#FF69B4; --red:#ff4444; --orange:#ff8c00;
    }

    body{
      background:var(--bg); color:var(--text);
      font-family:Inter,system-ui,sans-serif;
      margin:0; padding:40px;
      display:flex; flex-direction:column; gap:40px;
      min-height:100vh; box-sizing:border-box;
      overflow-x:hidden;
    }

    .header{
      display:flex; justify-content:space-between; align-items:center;
      border-bottom:1px solid #222; padding-bottom:30px;
    }
    .logo-area{ display:flex; align-items:center; gap:15px; }
    .logo-img{ height:70px; width:auto; }

    .gleam{
      font-weight:800; font-size:32px; letter-spacing:3px; margin:0;
      background:linear-gradient(to right,#BF953F 0%,#FCF6BA 25%,#B38728 50%,#FBF5B7 75%,#AA771C 100%);
      background-size:200% auto;
      -webkit-background-clip:text; -webkit-text-fill-color:transparent;
      animation:shine 5s linear infinite;
    }
    @keyframes shine{ to { background-position:200% center; } }

    .brand-bottom{
      display:flex; align-items:center; gap:10px; margin-top:5px;
      color:#fff; font-size:11px; text-transform:uppercase;
      letter-spacing:1.5px; font-weight:300;
    }
    .status-dot-active{
      width:5px; height:5px; border-radius:50%;
      background:var(--lime); box-shadow:0 0 10px var(--lime);
      animation:pulse-lime 2s infinite;
    }
    @keyframes pulse-lime{ 0%{opacity:1} 50%{opacity:.4} 100%{opacity:1} }

    #digital-clock{ font-size:52px; font-weight:700; text-align:right; letter-spacing:-2px; line-height:1; }
    .city-grid{ display:flex; gap:18px; margin-top:12px; justify-content:flex-end; }
    .city-item{ font-size:10px; color:#fff; display:flex; align-items:center; gap:6px; font-weight:700; cursor:pointer; transition:color .3s; }
    .status-dot{ width:6px; height:6px; background:#fff; border-radius:50%; transition:.3s; }

    .city-open{ color:var(--lime) !important; }
    .city-open .status-dot{ background:var(--lime) !important; box-shadow:0 0 12px var(--lime); }
    .comms-flash{ color:var(--pink) !important; transition:.1s; }

    .macro-header{
      font-size:14px; font-weight:700; color:#555;
      text-transform:uppercase; letter-spacing:4px;
      margin-bottom:-20px; border-left:3px solid var(--gold); padding-left:15px;
    }

    .grid{ display:grid; grid-template-columns:repeat(4,1fr); gap:20px; }
    .card{
      background:var(--card); padding:35px; border-radius:8px;
      border:1px solid #1f1f1f;
      transition:all .6s cubic-bezier(0.4,0,0.2,1);
      display:flex; flex-direction:column;
    }
    .card h3{
      font-size:10px; color:#555; text-transform:uppercase;
      margin:0 0 20px 0; letter-spacing:2px;
    }
    .primary-text{
      font-size:19px; font-weight:800; color:#fff; text-transform:uppercase;
      display:flex; align-items:center; gap:10px;
    }
    .secondary-text{
      font-size:11px; font-weight:700; margin-top:8px;
      text-transform:uppercase; letter-spacing:1px;
    }

    /* ✅ RESTORED “REGIME HUM” / FADED BACKGROUNDS */
    .halo-bg-gold{
      border-color: var(--gold) !important;
      background: linear-gradient(145deg, #111111 0%, #2a2210 100%) !important;
      box-shadow:
        0 0 30px rgba(191,149,63,.15),
        inset 0 0 20px rgba(191,149,63,.10);
    }
    .halo-bg-silver{
      border-color: var(--silver) !important;
      background: linear-gradient(145deg, #111111 0%, #1a1a1a 100%) !important;
      box-shadow:
        0 0 30px rgba(192,192,192,.15),
        inset 0 0 20px rgba(192,192,192,.08);
    }
    .glow-lime{
      border-color: var(--lime) !important;
      background: linear-gradient(145deg, #111111 0%, #0a1f0a 100%) !important;
      box-shadow:
        0 0 26px rgba(50,205,50,.12),
        inset 0 0 22px rgba(50,205,50,.10);
    }
    .glow-warning{
      border-color: var(--orange) !important;
      background: linear-gradient(145deg, #111111 0%, #2a1a0a 100%) !important;
      box-shadow:
        0 0 26px rgba(255,140,0,.12),
        inset 0 0 22px rgba(255,140,0,.10);
    }
    .glow-danger{
      border-color: var(--red) !important;
      background: linear-gradient(145deg, #111111 0%, #2a0a0a 100%) !important;
      box-shadow:
        0 0 26px rgba(255,68,68,.14),
        inset 0 0 22px rgba(255,68,68,.12);
    }

    .track{ width:100%; height:4px; background:#1a1a1a; margin-top:18px; border-radius:2px; overflow:hidden; display:none; }
    .fill{ height:100%; width:0%; transition:1.2s; background:var(--gold); }

    .pulse-container{ display:flex; justify-content:center; align-items:center; padding:15px 0; flex-grow:1; }
    .pulse-node{ width:55px; height:55px; border-radius:50%; background:var(--dim); transition:.4s; }
    .pulse-slow{ animation:node-pulse 3s infinite ease-in-out; }
    .pulse-mid{ animation:node-pulse 1.2s infinite ease-in-out; }
    .pulse-fast{ animation:node-pulse .5s infinite ease-in-out; }
    @keyframes node-pulse{
      0%{transform:scale(.9);opacity:.5}
      50%{transform:scale(1.1);opacity:1}
      100%{transform:scale(.9);opacity:.5}
    }
    .recession-text{ font-size:12px !important; text-align:center; justify-content:center; margin-top:10px; }

    #password-modal{
      display:none; position:fixed; top:0; left:0; width:100%; height:100%;
      background:rgba(0,0,0,.95); z-index:10000;
      justify-content:center; align-items:center;
    }
    .modal-content{ background:#111; padding:30px; border:1px solid var(--gold); border-radius:4px; text-align:center; }
    .modal-input{
      background:#000; border:1px solid #333; color:#fff;
      padding:10px; width:200px; text-align:center;
      margin-bottom:20px; outline:none; font-family:monospace; letter-spacing:4px;
    }
  </style>
</head>

<body>
  <header class="header">
    <div class="logo-area">
      <img src="/static/logo.png" class="logo-img" alt="Logo" />
      <div style="width:1px;height:55px;background:#222;margin:0 20px;"></div>
      <div>
        <div style="display:flex;align-items:baseline;gap:10px;">
          <h1 class="gleam">SUTTON HOUSE</h1>
          <span style="color:#fff;font-size:16px;font-weight:300;letter-spacing:1px;text-transform:uppercase;">Market Analytics</span>
        </div>
        <div class="brand-bottom">MARKET MONITOR <div class="status-dot-active"></div> <span style="color:var(--lime);font-family:monospace;font-weight:bold;">TERMINAL ACTIVE</span></div>
      </div>
    </div>

    <div>
      <div id="digital-clock">00:00:00</div>
      <div class="city-grid">
        <div class="city-item" id="city-lon"><div class="status-dot"></div> LONDON</div>
        <div class="city-item" id="city-ny"><div class="status-dot"></div> NEW YORK</div>
        <div class="city-item" id="city-tor"><div class="status-dot"></div> TORONTO</div>
        <div class="city-item" id="city-syd"><div class="status-dot"></div> SYDNEY</div>
      </div>
    </div>
  </header>

  <div class="macro-header">Macro Analysis</div>

  <main class="grid">
    <div class="card" id="card-1">
      <h3 id="h3-1">Regime &amp; Volatility</h3>
      <div class="primary-text" id="val-1">AWAITING</div>
      <div class="secondary-text" id="sub-1"></div>
    </div>

    <div class="card" id="card-2">
      <h3 id="h3-2">Capital Rotation</h3>
      <div class="primary-text" id="val-2">AWAITING</div>
      <div class="secondary-text" id="sub-2"></div>
    </div>

    <div class="card" id="card-3">
      <h3 id="h3-3">Cycle Maturity</h3>
      <div class="primary-text" id="val-3">AWAITING</div>
      <div class="secondary-text" id="sub-3"></div>
      <div class="track" id="track-3"><div class="fill" id="fill-3"></div></div>
    </div>

    <div class="card" id="card-4">
      <h3>Recession Pulse</h3>
      <div class="pulse-container"><div id="led-node" class="pulse-node"></div></div>
      <div class="primary-text recession-text" id="val-4">AWAITING</div>
      <div class="secondary-text" id="sub-4" style="display:none;"></div>
    </div>
  </main>

  <div id="password-modal">
    <div class="modal-content">
      <h2 style="color:var(--gold);font-size:10px;letter-spacing:3px;margin-bottom:20px;text-transform:uppercase;">Encryption Key Required</h2>
      <input type="password" id="pass-input" class="modal-input" placeholder="****" />
      <div style="display:flex;gap:10px;justify-content:center;">
        <button onclick="checkPass()" style="background:var(--gold);border:none;color:#000;padding:8px 15px;font-weight:bold;cursor:pointer;font-size:10px;">VERIFY</button>
        <button onclick="closeModal()" style="background:none;border:1px solid #333;color:#555;padding:8px 15px;cursor:pointer;font-size:10px;">ABORT</button>
      </div>
    </div>
  </div>

  <script>
    // ----------------------------
    // CLOCK MUST ALWAYS RUN
    // ----------------------------
    function tick(){
      const now = new Date();
      const clock = document.getElementById('digital-clock');
      if (clock) clock.innerText = now.toLocaleTimeString('en-GB', {hour12:false});

      const hrs = now.getUTCHours();
      const setCity = (id, open) => {
        const el = document.getElementById(id);
        if (el) el.className = open ? 'city-item city-open' : 'city-item';
      };

      setCity('city-lon', hrs >= 8 && hrs < 16);
      setCity('city-ny',  hrs >= 13 && hrs < 21);
      setCity('city-tor', hrs >= 13 && hrs < 21);
      setCity('city-syd', hrs >= 22 || hrs < 6);
    }
    tick();
    setInterval(tick, 1000);

    function triggerPulse(){
      document.querySelectorAll('.city-item').forEach(i => i.classList.add('comms-flash'));
      setTimeout(() => document.querySelectorAll('.city-item').forEach(i => i.classList.remove('comms-flash')), 400);
    }

    // ----------------------------
    // SECRET MODE (Cards 1–3 become the secret UI)
    // ----------------------------
    let secretMode = false;

    function setText(id, txt){
      const el = document.getElementById(id);
      if (el) el.innerText = txt;
    }

    function enableSecretMode(){
      secretMode = true;

      setText('h3-1', 'Institutional Alpha');
      setText('h3-2', 'Order Flow');
      setText('h3-3', 'Liquidity Timing');

      ['card-1','card-2','card-3'].forEach(id => {
        const c = document.getElementById(id);
        if (c) c.className = 'card halo-bg-gold';
      });

      // Force text + override any old inline colours from public mode
      const v1 = document.getElementById('val-1');
      const v2 = document.getElementById('val-2');
      const v3 = document.getElementById('val-3');
      if (v1){ v1.innerText = 'SECURE FEED'; v1.style.color = 'var(--gold)'; }
      if (v2){ v2.innerText = 'SECURE FEED'; v2.style.color = 'var(--gold)'; }
      if (v3){ v3.innerText = 'SECURE FEED'; v3.style.color = 'var(--gold)'; }

      const s1 = document.getElementById('sub-1');
      const s2 = document.getElementById('sub-2');
      const s3 = document.getElementById('sub-3');
      if (s1){ s1.innerText = 'AWAITING SIGNAL'; s1.style.color = 'var(--gold)'; }
      if (s2){ s2.innerText = 'AWAITING SIGNAL'; s2.style.color = 'var(--gold)'; }
      if (s3){ s3.innerText = 'AWAITING SIGNAL'; s3.style.color = 'var(--gold)'; }

      const t3 = document.getElementById('track-3');
      if (t3) t3.style.display = 'none';
    }

    function closeVault(){
      secretMode = false;

      setText('h3-1', 'Regime & Volatility');
      setText('h3-2', 'Capital Rotation');
      setText('h3-3', 'Cycle Maturity');

      ['card-1','card-2','card-3'].forEach(id => {
        const c = document.getElementById(id);
        if (c) c.className = 'card';
      });

      // Clear any inline styles we set in secret mode
      ['val-1','val-2','val-3'].forEach(id => {
        const el = document.getElementById(id);
        if (el){ el.innerText = 'AWAITING'; el.style.color = ''; }
      });
      ['sub-1','sub-2','sub-3'].forEach(id => {
        const el = document.getElementById(id);
        if (el){ el.innerText = ''; el.style.color = ''; }
      });

      const t3 = document.getElementById('track-3');
      if (t3) t3.style.display = 'block';
    }
    window.closeVault = closeVault;

    // ----------------------------
    // SOCKET.IO (GUARDED)
    // ----------------------------
    let socket = null;
    try{
      if (window.io){
        socket = io({ transports:['polling','websocket'], upgrade:true, reconnection:true });
        socket.on('connect', () => console.log('CONNECTED'));
        socket.on('connect_error', (e) => console.log('SOCKET ERROR', e));
      } else {
        console.log('Socket.IO not loaded; clock will still run.');
      }
    } catch(e){
      console.log('Socket init failed; clock will still run.', e);
    }

    // ----------------------------
    // LIVE MACRO UPDATES
    // ----------------------------
    if (socket){
      socket.on('macro_update', (data) => {
        triggerPulse();

        // Cards 1–3 only update in public mode
        if (!secretMode){
          if (data.cycle){
            const v1 = document.getElementById('val-1');
            const c1 = document.getElementById('card-1');
            const isCom = String(data.cycle).toLowerCase().includes('commodities');
            if (v1){
              v1.innerText = isCom ? 'STRONG COMMODITIES MACRO' : String(data.cycle).toUpperCase();
              v1.style.color = isCom ? 'var(--gold)' : 'var(--text)';
            }
            if (c1) c1.className = isCom ? 'card halo-bg-gold' : 'card halo-bg-silver';
          }

          if (data.vol){
            const s1 = document.getElementById('sub-1');
            if (s1){
              s1.innerText = 'VOLATILITY: ' + String(data.vol).toUpperCase();
              s1.style.color = (String(data.vol).toUpperCase() === 'ELEVATED') ? 'var(--red)' : 'var(--lime)';
            }
          }

          if (data.flow){
            const v2 = document.getElementById('val-2');
            const s2 = document.getElementById('sub-2');
            const c2 = document.getElementById('card-2');

            const flowStr = String(data.flow).toLowerCase();
            const flowGold = flowStr.includes('commod') || flowStr.includes('offensive');

            if (v2){
              v2.innerText = 'ROTATION ACTIVE';
              v2.style.color = flowGold ? 'var(--gold)' : 'var(--text)';
            }
            if (s2) s2.innerText = String(data.flow).toUpperCase();
            if (c2) c2.className = flowGold ? 'card halo-bg-gold' : 'card halo-bg-silver';
          }

          // CARD 3 maturity
          if (data.count !== undefined && data.count !== null){
            const count = Number.parseInt(data.count, 10);

            const v3 = document.getElementById('val-3');
            const s3 = document.getElementById('sub-3');
            const c3 = document.getElementById('card-3');
            const t3 = document.getElementById('track-3');
            const f3 = document.getElementById('fill-3');

            if (Number.isFinite(count)){
              if (t3) t3.style.display = 'block';
              if (f3) f3.style.width = count + '%';
              if (s3) s3.innerText = 'MATURITY: ' + count + '%';

              const cycleStr = String(data.cycle || '').toLowerCase();
              const isCommodities = cycleStr.includes('commod');

              if (count <= 0){
                if (v3){ v3.innerText = 'INITIATING'; v3.style.color = 'var(--dim)'; }
                if (c3) c3.className = 'card';
                if (f3) f3.style.background = 'var(--dim)';
              } else if (count <= 25){
                if (v3){ v3.innerText = 'EARLY CYCLE'; v3.style.color = 'var(--lime)'; }
                if (c3) c3.className = 'card glow-lime';
                if (f3) f3.style.background = 'var(--lime)';
              } else if (count <= 70){
                if (v3) v3.innerText = 'ESTABLISHED CYCLE';
                if (v3) v3.style.color = isCommodities ? 'var(--gold)' : 'var(--silver)';
                if (c3) c3.className = isCommodities ? 'card halo-bg-gold' : 'card halo-bg-silver';
                if (f3) f3.style.background = isCommodities ? 'var(--gold)' : 'var(--silver)';
              } else {
                const endCol = (count > 85) ? 'var(--red)' : 'var(--orange)';
                if (v3){ v3.innerText = 'CYCLE END APPROACHING'; v3.style.color = endCol; }
                if (c3) c3.className = (count > 85) ? 'card glow-danger' : 'card glow-warning';
                if (f3) f3.style.background = endCol;
              }
            } else {
              if (s3) s3.innerText = 'MATURITY: --';
            }
          }
        }

        // Card 4 always live
        if (data.sahm !== undefined && data.sahm !== null){
          const s = parseFloat(data.sahm) || 0;
          const v4 = document.getElementById('val-4');
          const c4 = document.getElementById('card-4');
          const node = document.getElementById('led-node');

          if (s <= 0.34){
            if (v4) v4.innerText = 'EXPANSION PHASE';
            if (c4) c4.className = 'card glow-lime';
            if (node){ node.className = 'pulse-node pulse-slow'; node.style.background = 'var(--lime)'; node.style.boxShadow = '0 0 40px var(--lime)'; }
          } else if (s <= 0.49){
            if (v4) v4.innerText = 'WARNING: APPROACHING RECESSION';
            if (c4) c4.className = 'card glow-warning';
            if (node){ node.className = 'pulse-node pulse-mid'; node.style.background = 'var(--orange)'; node.style.boxShadow = '0 0 40px var(--orange)'; }
          } else {
            if (v4) v4.innerText = 'CONTRACTION';
            if (c4) c4.className = 'card glow-danger';
            if (node){ node.className = 'pulse-node pulse-fast'; node.style.background = 'var(--red)'; node.style.boxShadow = '0 0 60px var(--red)'; }
          }
        }
      });
    }

    // ----------------------------
    // PASSWORD MODAL (SERVER VERIFY)
    // ----------------------------
    const tor = document.getElementById('city-tor');
    if (tor){
      tor.addEventListener('dblclick', () => {
        const modal = document.getElementById('password-modal');
        const input = document.getElementById('pass-input');
        if (modal) modal.style.display = 'flex';
        if (input) input.focus();
      });
    }

    function closeModal(){
      const modal = document.getElementById('password-modal');
      const input = document.getElementById('pass-input');
      if (modal) modal.style.display = 'none';
      if (input) input.value = '';
    }
    window.closeModal = closeModal;

    async function checkPass(){
      const input = document.getElementById('pass-input');
      const pwd = input ? input.value : '';

      try{
        const r = await fetch('/verify_secret', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ password: pwd })
        });
        closeModal();
        if (r.ok) enableSecretMode();
      } catch(e){
        closeModal();
      }
    }
    window.checkPass = checkPass;

    const passInput = document.getElementById('pass-input');
    if (passInput){
      passInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') checkPass();
      });
    }
  </script>
</body>
</html>
