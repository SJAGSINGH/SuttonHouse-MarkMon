<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sutton House | Master Terminal</title>

  <!-- Socket.IO -->
 <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

<script>
// HARD FAIL-SOFT GUARD (GLOBAL)
window.onerror = function (msg, src, line, col, err) {
  console.error("[UI ERROR]", msg, "at", src + ":" + line + ":" + col, err);
  return true; // fail-soft
};
</script>

<script>
// GLOBAL STATE (must exist before any JS uses it)
let secretMode = false;
let founderMode = false;
</script>

  <!-- Styles -->
<style>
  :root{
    --bg:#050505; --card:#111111; --text:#ffffff;
    --dim:#333333; --lime:#32CD32; --gold:#BF953F; --silver:#C0C0C0;
    --pink:#FF69B4; --red:#ff4444; --orange:#ff8c00;

    --secret:#1fa67a;
    --secret-bg-1:#0b1512;
    --secret-bg-2:#0f2a21;

    --war-1:#12080a;
    --war-2:#061313;

    --gseg-off:#1b1b1b;
    --gseg-off-b:#242424;

    /* ============================
       BLUE STEEL (Financial Asset Regime)
    ============================ */
    --steel:#4aa3ff;
    --steel-bg-1:#0b1320;
    --steel-bg-2:#0e1f36;
  }
  /* ============================
   CARD 2 — CAPITAL ROTATION
   Matches Card 1 behaviour
   ============================ */

/* ============================================================
   CARD 2 — tidy text styling (paste into <style> in index.html)
   Put this near your other card styles (e.g. after Card 1 rules)
   ============================================================ */

/* CARD 2 text treatment (matches Card 1 behaviour) */
  #card-2 .primary-text{
    color:#ffffff;
    font-weight:600;
    text-transform:uppercase;
  }

  #card-2 .secondary-text{
    margin-top:6px;
    font-size:12px;
    letter-spacing:0.04em;
    text-transform:uppercase;
  }

  /* State colours */
  .card2-green{ color: var(--lime); }
  .card2-red{ color: var(--red); }
  .card2-neutral{ color: rgba(255,255,255,0.65); }

  body{
    background:var(--bg); color:var(--text);
    font-family:Inter,system-ui,sans-serif;
    margin:0; padding:22px 40px 40px;  /* pulls header up */
    display:flex; flex-direction:column; gap:40px;
    min-height:100vh; box-sizing:border-box;
    overflow-x:hidden;
    transition:background .35s ease;
  }

  body.war-room{
    background:
      radial-gradient(1100px 700px at 15% 10%, rgba(255,68,68,.10), transparent 55%),
      radial-gradient(900px 600px at 85% 25%, rgba(31,166,122,.10), transparent 55%),
      linear-gradient(145deg, var(--war-1), var(--war-2));
  }


/* ============================
   HEADER — FINAL ALIGN (LOCKED)
============================ */

.header{
  display:grid;
  grid-template-columns: 340px 1fr 160px;  /* LEFT / CENTER / SCADA */
  align-items:center;
  border-bottom:1px solid #222;
  padding:0 0 6px;                         /* border sits higher */
  gap:18px;
  margin-top:-10px;                        /* lift the whole header slightly */
}

/* LEFT */
.logo-area{
  display:flex;
  flex-direction:column;
  align-items:center;                      /* crest centered to wordmark */
  justify-content:center;
  gap:0;
}

.logo-img{
  height:150px;
  width:auto;
  display:block;
  margin:0 0 -26px 0;                      /* pulls text closer + up */
}

.brand-stack{
  width:fit-content;                       /* stops stretching */
  text-align:center;                       /* centers SUTTON HOUSE under crest */
  margin-top:-10px;                        /* move Sutton House up a touch */
  padding:0;
}

.gleam{ margin:0; line-height:1; }

.brand-subtitle{
  margin-top:2px;
  display:flex;
  align-items:center;
  justify-content:center;
  gap:12px;
  line-height:1;
}

/* terminal line */
.brand-bottom{
  display:inline-flex;
  align-items:center;
  gap:10px;
  margin:0 !important;
  line-height:1;
}

/* CENTER */
.center-stack{
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  text-align:center;
  gap:4px;
}

/* clock */
#digital-clock{
  font-size:38px;
  font-weight:700;
  letter-spacing:-1px;
  line-height:1;
  margin:0;
}



/* cities */
/* CITY LINE — HORIZONTAL */
.city-grid{
  display:flex;
  flex-direction:row;
  justify-content:center;
  align-items:center;
  gap:14px;
  margin-top:6px;
  font-size:10px;
  letter-spacing:1.5px;
}

.city-item{
  display:flex;
  align-items:center;
  gap:6px;
  font-size:10px;
  font-weight:700;
  text-transform:uppercase;
  color:#9a9a9a;
  transition:color .25s ease;
}

/* active market */
.city-open{
  color:var(--lime) !important;
}

.city-item .status-dot{
  width:5px;
  height:5px;
  border-radius:50%;
  background:#666;
}

.city-open .status-dot{
  background:var(--lime);
  box-shadow:0 0 10px rgba(50,205,50,.8);
}


/* small comms pulse on receive */
.comms-flash{
  filter:brightness(1.35);
}


/* ============================
   SCADA MAN — seated + contained (LOCK v3)
   Fix: sits LOWER (strong seat)
   Sway: forward/back (reduced lift)
============================ */

#scada-comms{ display:none !important; }
#dbg-toggle{ display:none; }

.scada-slot{
  width:160px;
  height:160px;
  display:flex;
  align-items:center;
  justify-content:flex-end;
  pointer-events:none;
}

.scada-card{
  width:160px;
  height:160px;
  border-radius:14px;
  border:1px solid rgba(31,166,122,.18);
  background:rgba(0,0,0,.18);
  box-shadow:
    0 0 24px rgba(31,166,122,.12),
    inset 0 0 18px rgba(31,166,122,.08);
  display:flex;
  align-items:center;
  justify-content:center;
  overflow:hidden;
}

/* INNER frame */
.scada-man-wrap{
  width:142px;
  height:142px;
  border-radius:12px;
  border:1px solid rgba(31,166,122,.22);
  background:rgba(0,0,0,.12);
  box-shadow:
    0 0 26px rgba(31,166,122,.14),
    inset 0 0 20px rgba(31,166,122,.10);

  /* SEAT HIM HARDER */
  display:flex;
  align-items:flex-end;
  justify-content:center;
  padding-bottom:18px;          /* was 10 */
  overflow:hidden;

  /* forward/back sway */
  transform-origin:50% 94%;
  animation:scada-sway-fb 7.6s ease-in-out infinite;
}

.scada-man{
  width:118px;
  height:auto;
  display:block;
  object-fit:contain;

  /* FINAL seat nudge */
  margin:0 auto;
  transform: translateY(16px);  /* was 6 */

  filter:
    drop-shadow(0 0 14px rgba(31,166,122,.22))
    drop-shadow(0 0 28px rgba(31,166,122,.12));
  opacity:.96;
}

/* forward/back sway — reduced lift so he doesn't climb */
@keyframes scada-sway-fb{
  0%   { transform: translateY(0px) scale(1); }
  50%  { transform: translateY(-1px) scale(1.012); }
  100% { transform: translateY(0px) scale(1); }
}

body.war-room .scada-card{
  box-shadow:
    0 0 30px rgba(31,166,122,.16),
    inset 0 0 20px rgba(31,166,122,.10);
}







/* kill old rail classes if still present */
.right-rail,
.right-stack{ display:contents !important; }


  .gleam{
    font-weight:800; font-size:32px; letter-spacing:3px; margin:0;
    background:linear-gradient(to right,#BF953F 0%,#FCF6BA 25%,#B38728 50%,#FBF5B7 75%,#AA771C 100%);
    background-size:200% auto;
    -webkit-background-clip:text; -webkit-text-fill-color:transparent;
    animation:shine 5s linear infinite;
  }
  @keyframes shine{ to { background-position:200% center; } }

  .brand-bottom{
    display:flex; align-items:center; gap:10px; margin-top:5px;
    color:#fff; font-size:11px; text-transform:uppercase;
    letter-spacing:1.5px; font-weight:300;
  }
  .status-dot-active{
    width:5px; height:5px; border-radius:50%;
    background:var(--lime); box-shadow:0 0 10px var(--lime);
    animation:pulse-lime 2s infinite;
  }
  @keyframes pulse-lime{ 0%{opacity:1} 50%{opacity:.4} 100%{opacity:1} }



  .macro-header{
    font-size:14px; font-weight:700; color:#555;
    text-transform:uppercase; letter-spacing:4px;
    margin-bottom:-20px; border-left:3px solid var(--gold); padding-left:15px;
    display:flex; align-items:center; justify-content:space-between; gap:18px;
  }
  #scada-comms.flash {
    color: var(--lime);
    text-shadow: 0 0 12px rgba(50,205,50,.25);
    transition: .08s;
  }

  /* Public teaser badge (shows only when war.active=true and NOT in secret mode) */
  #war-badge{
    display:none;
    font-size:10px;
    letter-spacing:2px;
    text-transform:uppercase;
    color:var(--red);
    border:1px solid rgba(255,68,68,.35);
    background:rgba(0,0,0,.25);
    padding:7px 10px;
    border-radius:999px;
    white-space:nowrap;
    user-select:none;
  }

  .grid{ display:grid; grid-template-columns:repeat(4,1fr); gap:20px; }
  .card{
    background:var(--card); padding:35px; border-radius:8px;
    border:1px solid #1f1f1f;
    transition:all .6s cubic-bezier(0.4,0,0.2,1);
    display:flex; flex-direction:column;
    position:relative;
    min-height:170px;
  }
  .card h3{
    font-size:10px; color:#555; text-transform:uppercase;
    margin:0 0 20px 0; letter-spacing:2px;
  }
  .primary-text{
    font-size:19px; font-weight:800; color:#fff; text-transform:uppercase;
    display:flex; align-items:center; gap:10px;
  }
  .secondary-text{
    font-size:11px; font-weight:700; margin-top:8px;
    text-transform:uppercase; letter-spacing:1px;
  }

  .halo-bg-gold{
    border-color: var(--gold) !important;
    background: linear-gradient(145deg, #111111 0%, #2a2210 100%) !important;
    box-shadow: 0 0 30px rgba(191,149,63,.15), inset 0 0 20px rgba(191,149,63,.10);
  }
  .halo-bg-silver{
    border-color: var(--silver) !important;
    background: linear-gradient(145deg, #111111 0%, #1a1a1a 100%) !important;
    box-shadow: 0 0 30px rgba(192,192,192,.15), inset 0 0 20px rgba(192,192,192,.08);
  }

  /* ============================
     BLUE STEEL (Financial Asset Regime)
  ============================ */
  .halo-bg-steel{
    border-color: var(--steel) !important;
    background: linear-gradient(145deg, var(--steel-bg-1) 0%, var(--steel-bg-2) 100%) !important;
    box-shadow: 0 0 30px rgba(74,163,255,.14), inset 0 0 22px rgba(74,163,255,.10);
  }

  /* Optional Founder haze overlays (safe to leave even if unused for now) */
  .haze-steel{
    box-shadow:
      0 0 40px rgba(74,163,255,.10),
      inset 0 0 28px rgba(74,163,255,.08) !important;
  }
  .haze-gold{
    box-shadow:
      0 0 40px rgba(191,149,63,.10),
      inset 0 0 28px rgba(191,149,63,.08) !important;
  }

  .glow-lime{
    border-color: var(--lime) !important;
    background: linear-gradient(145deg, #111111 0%, #0a1f0a 100%) !important;
    box-shadow: 0 0 26px rgba(50,205,50,.12), inset 0 0 22px rgba(50,205,50,.10);
  }
  .glow-warning{
    border-color: var(--orange) !important;
    background: linear-gradient(145deg, #111111 0%, #2a1a0a 100%) !important;
    box-shadow: 0 0 26px rgba(255,140,0,.12), inset 0 0 22px rgba(255,140,0,.10);
  }
  .glow-danger{
    border-color: var(--red) !important;
    background: linear-gradient(145deg, #111111 0%, #2a0a0a 100%) !important;
    box-shadow: 0 0 26px rgba(255,68,68,.14), inset 0 0 22px rgba(255,68,68,.12);
  }

  .halo-bg-secret{
    border-color: var(--secret) !important;
    background: linear-gradient(145deg, var(--secret-bg-1) 0%, var(--secret-bg-2) 100%) !important;
    box-shadow: 0 0 34px rgba(31,166,122,.22), inset 0 0 26px rgba(31,166,122,.18);
  }

  .track{ width:100%; height:4px; background:#1a1a1a; margin-top:18px; border-radius:2px; overflow:hidden; display:none; }
  .fill{ height:100%; width:0%; transition:1.2s; background:var(--gold); }

  .pulse-container{ display:flex; justify-content:center; align-items:center; padding:15px 0; flex-grow:1; }
  .pulse-node{ width:55px; height:55px; border-radius:50%; background:var(--dim); transition:.4s; }
  .pulse-slow{ animation:node-pulse 3s infinite ease-in-out; }
  .pulse-mid{ animation:node-pulse 1.2s infinite ease-in-out; }
  .pulse-fast{ animation:node-pulse .5s infinite ease-in-out; }
  @keyframes node-pulse{ 0%{transform:scale(.9);opacity:.5} 50%{transform:scale(1.1);opacity:1} 100%{transform:scale(.9);opacity:.5} }
  .recession-text{ font-size:12px !important; text-align:center; justify-content:center; margin-top:10px; }

  #password-modal{
    display:none; position:fixed; top:0; left:0; width:100%; height:100%;
    background:rgba(0,0,0,.95); z-index:10000;
    justify-content:center; align-items:center;
  }
  .modal-content{ background:#111; padding:30px; border:1px solid var(--gold); border-radius:4px; text-align:center; }
  .modal-input{
    background:#000; border:1px solid #333; color:#fff;
    padding:10px; width:200px; text-align:center;
    margin-bottom:20px; outline:none; font-family:monospace; letter-spacing:4px;
  }

  #vault-exit{
    display:none;
    margin-top:18px;
    padding:10px 14px;
    background:rgba(0,0,0,.25);
    border:1px solid rgba(31,166,122,.55);
    color:var(--secret);
    font-size:10px;
    letter-spacing:2px;
    text-transform:uppercase;
    cursor:pointer;
    border-radius:6px;
    width:fit-content;
    align-self:flex-start;
    transition:all .25s ease;
  }
  #vault-exit:hover{
    background:rgba(31,166,122,.08);
    box-shadow:0 0 18px rgba(31,166,122,.18);
  }

  /* Gauges */
  .gauge{
    margin-top:14px;
    display:flex;
    gap:10px;
    align-items:center;
  }
  .gauge-title{
    font-size:10px;
    color:#8a8a8a;
    letter-spacing:2px;
    text-transform:uppercase;
    min-width:120px;
    user-select:none;
  }
  .gauge-bars{
    display:grid;
    grid-template-columns:repeat(10, 1fr);
    gap:5px;
    width:100%;
  }
  .gseg{
    height:10px;
    border-radius:3px;
    background:var(--gseg-off);
    border:1px solid var(--gseg-off-b);
    transition:.25s;
  }
  .gmeta{
    margin-top:10px;
    font-size:10px;
    color:#8a8a8a;
    letter-spacing:1.4px;
    text-transform:uppercase;
    line-height:1.4;
  }
  .gmeta strong{ color:#fff; letter-spacing:1.2px; }

  /* ============================
     MONITORING STATE CARD
  ============================ */
  .section-header{
    font-size:14px; font-weight:700; color:#555;
    text-transform:uppercase; letter-spacing:4px;
    margin-bottom:-20px;
    border-left:3px solid var(--gold);
    padding-left:15px;
  }

  .card-wide{
    grid-column:1 / -1;
    min-height:180px;
  }

  .badge-row{
    display:flex;
    flex-wrap:wrap;
    gap:10px;
    margin-top:16px;
  }

  .badge{
    font-size:10px;
    letter-spacing:2px;
    text-transform:uppercase;
    padding:7px 12px;
    border-radius:999px;
    border:1px solid #2a2a2a;
    background:#0b0b0b;
    color:#cfcfcf;
  }

  .badge-good{
    border-color:rgba(50,205,50,.45);
    color:var(--lime);
  }
  .badge-warn{
    border-color:rgba(255,140,0,.45);
    color:var(--orange);
  }
  .badge-bad{
    border-color:rgba(255,68,68,.45);
    color:var(--red);
  }
 

  .mono{
    font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
  }

  /* ============================
   SENTINEL
============================ */
.sentinel-output{
  font-size:13px;
  letter-spacing:1px;
  line-height:1.6;
  color:var(--lime);
  min-height:40px;
}

/* ============================
   WAIT STEPS
============================ */
.wait-step{
  font-size:11px;
  letter-spacing:1.5px;
  text-transform:uppercase;
  padding:8px 10px;
  margin-bottom:6px;
  border-left:3px solid #333;
  color:#666;
}

.wait-step.active{
  border-left-color:var(--lime);
  color:var(--lime);
}

.wait-step.past{
  color:#444;
}

/* ============================
   STOCK GRID
============================ */
.stock-grid{
  display:grid;
  grid-template-columns:repeat(5,1fr);
  gap:14px;
  margin-top:20px;
}

.stock-node{
  width:100%;
  aspect-ratio:1;
  border-radius:50%;
  background:#222;
  border:1px solid #333;
}

/* STATES */
.stock-node.grey{
  background:#1a1a1a;
  border-color:#333;
}

.stock-node.amber{
  background:rgba(255,140,0,.15);
  border-color:var(--orange);
  box-shadow:0 0 12px rgba(255,140,0,.25);
}

.stock-node.green{
  background:rgba(50,205,50,.15);
  border-color:var(--lime);
  box-shadow:0 0 14px rgba(50,205,50,.35);
}

</style>

</head>

<body>
  


  <header class="header">

  <!-- LEFT: Crest + Brand -->
  <div class="logo-area">
    <img src="/static/logo.png" class="logo-img" alt="Logo" />

    <div class="brand-stack">
      <h1 class="gleam">SUTTON HOUSE</h1>
      <div class="brand-subtitle">
        MARKET ANALYTICS
        <span class="brand-bottom" id="terminal-line">
          <span class="status-dot-active" id="term-dot"></span>
          <span class="terminal-active" id="term-text">TERMINAL ACTIVE</span>
        </span>
      </div>
    </div>
  </div>

  <!-- CENTER: Clock + Cities -->
  <div class="center-stack">
    <div id="digital-clock">00:00:00</div>

    <div class="city-grid">
      <div class="city-item" id="city-lon"><div class="status-dot"></div>LONDON</div>
      <div class="city-item" id="city-ny"><div class="status-dot"></div>NEW YORK</div>
      <div class="city-item" id="city-tor"><div class="status-dot"></div>TORONTO</div>
      <div class="city-item" id="city-syd"><div class="status-dot"></div>SYDNEY</div>
    </div>

    <!-- Hidden comms (JS integrity) -->
    <div id="scada-comms" class="mono scada-comms-hidden">
      <span id="scada-age">AGE: —</span>
      <span id="scada-source">SOURCE: —</span>
      <span id="scada-last">LAST: —</span>
    </div>

    <button id="dbg-toggle" class="dbg-btn">DEBUG</button>
  </div>

  <!-- RIGHT: SCADA Man -->
<div class="scada-slot">
  <div class="scada-card" aria-hidden="true">
    <div class="scada-man-wrap">
      <img src="/static/SCADA_Man.png" class="scada-man" alt="" />
    </div>
  </div>
</div>


</header>




  <div class="macro-header">
    <div>Macro Analysis</div>
    <div id="war-badge">WAR SIGNAL DETECTED — SECURE LAYER REQUIRED</div>
  </div>

  <button id="vault-exit" onclick="closeVault()">← Exit Secure Layer</button>

  <main class="grid">
    <div class="card" id="card-1">
      <h3 id="h3-1">Regime &amp; Volatility</h3>
      <div class="primary-text" id="val-1">AWAITING</div>
      <div class="secondary-text" id="sub-1"></div>
      <div id="gauge-1" style="display:none;"></div>
    </div>

    <div class="card" id="card-2">
      <h3 id="h3-2">Capital Rotation</h3>

      <!-- Main headline (white, big) -->
      <div class="primary-text" id="val-2">SHORT-TERM PREFERENCE REMAINS</div>

      <!-- Status line (small + coloured) -->
      <div class="secondary-text card2-neutral" id="val-2b">UNCLEAR — MONITORING</div>
    </div>


    <div class="card" id="card-3">
      <h3 id="h3-3">CYCLE CLOCK</h3>
      <div class="primary-text" id="val-3">AWAITING</div>
      <div class="secondary-text" id="sub-3"></div>
      <div class="track" id="track-3"><div class="fill" id="fill-3"></div></div>
      <div id="gauge-3" style="display:none;"></div>
    </div>
    
   <div class="card" id="card-4">
  <h3>Recession Pulse</h3>

  <!-- Pulse node -->
  <div class="pulse-container">
    <div id="led-node" class="pulse-node"></div>
  </div>

  <!-- Market Weakness (ONLY shown during Contraction) -->
  <div class="mw-wrap" id="mw-wrap" style="display:none;">
    <div class="mw-row">
      <div class="mw-title">MARKET WEAKNESS</div>
      <div class="mw-val" id="mw-val">—</div>
    </div>

    <div class="mw-bar" aria-hidden="true">
      <div class="mw-fill" id="mw-fill"></div>
      <div class="mw-capline"></div>
      <div class="mw-caplabel">35%</div>
    </div>

    <div class="mw-note" id="mw-note" style="display:none;">
      MARKET WEAKNESS THRESHOLD ACHIEVED
    </div>
  </div>

  <!-- Sahm state text -->
  <div class="primary-text recession-text" id="val-4">AWAITING</div>
  <div class="secondary-text" id="sub-4" style="display:none;"></div>
</div>

  </main>

{% include "sentinel.html" %}


  <div id="password-modal">
    <div class="modal-content">
      <h2 style="color:var(--gold);font-size:10px;letter-spacing:3px;margin-bottom:20px;text-transform:uppercase;">Encryption Key Required</h2>
      <input type="password" id="pass-input" class="modal-input" placeholder="****" />
      <div style="display:flex;gap:10px;justify-content:center;">
        <button onclick="checkPass()" style="background:var(--gold);border:none;color:#000;padding:8px 15px;font-weight:bold;cursor:pointer;font-size:10px;">VERIFY</button>
        <button onclick="closeModal()" style="background:none;border:1px solid #333;color:#555;padding:8px 15px;cursor:pointer;font-size:10px;">ABORT</button>
      </div>
    </div>
  </div>

  <script>
  // ----------------------------
  // CLOCK
  // ----------------------------
 // Terminal line should always be visible.
// Status color/text will reflect comms freshness (OFFLINE until first timestamp).
const term = document.getElementById('terminal-line');
if (term) term.style.display = 'inline-flex';

// default state on boot
setTerminalStatus('OFFLINE');

  function tick(){
  const now = new Date();

  // ---- DIGITAL CLOCK (UTC, authoritative) ----
  const clock = document.getElementById('digital-clock');
  if (clock){
    clock.innerText = now.toLocaleTimeString('en-GB', {
      hour12: false,
      timeZone: 'UTC'
    });
  }

  // ---- MARKET HOURS (UTC) ----
  const hrs = now.getUTCHours();

  const setCity = (id, open) => {
    const el = document.getElementById(id);
    if (!el) return;

    // hard reset first (prevents class buildup)
    el.classList.remove('city-open');

    if (open) el.classList.add('city-open');
  };

  // London: 08–16 UTC
  setCity('city-lon', hrs >= 8 && hrs < 16);

  // New York & Toronto: 13–21 UTC
  setCity('city-ny',  hrs >= 13 && hrs < 21);
  setCity('city-tor', hrs >= 13 && hrs < 21);

  // Sydney: 22–06 UTC (overnight wrap)
  setCity('city-syd', hrs >= 22 || hrs < 6);
}

  tick();
  setInterval(tick, 1000);

  function triggerPulse(){
    document.querySelectorAll('.city-item').forEach(i => i.classList.add('comms-flash'));
    setTimeout(() => document.querySelectorAll('.city-item').forEach(i => i.classList.remove('comms-flash')), 400);
  }
 

  

  // ----------------------------
  // COLOR PALETTES (rhyme with Pine)
  // ----------------------------
  const XY_COL = { 1:'rgb(255, 6, 6)',2:'rgb(252, 72, 0)',3:'rgb(244, 106, 0)',4:'rgb(230, 135, 0)',5:'rgb(215, 159, 0)',6:'rgb(197, 181, 0)',7:'rgb(176, 200, 0)',8:'rgb(149, 219, 0)',9:'rgb(106, 238, 0)',10:'rgb(0, 255, 26)' };
  const BUY_COL = { 1:'rgb(228,250,242)',2:'rgb(175,240,217)',3:'rgb(121,230,191)',4:'rgb(67,220,165)',5:'rgb(35,188,134)',6:'rgb(25,134,95)',7:'rgb(15,80,57)',8:'rgb(5,27,19)',9:'rgb(5,27,19)',10:'rgb(5,27,19)' };
  const SELL_COL= { 1:'rgb(250,228,228)',2:'rgb(240,175,175)',3:'rgb(230,121,121)',4:'rgb(220,67,67)',5:'rgb(188,35,35)',6:'rgb(134,25,25)',7:'rgb(80,15,15)',8:'rgb(27,5,5)',9:'rgb(27,5,5)',10:'rgb(27,5,5)' };

  function clampLevel(lv){ const n = Number(lv); if (!Number.isFinite(n)) return null; return Math.max(0, Math.min(10, Math.round(n))); }
  function segStyle(color){ return `background:${color};border-color:${color};box-shadow:0 0 12px rgba(255,255,255,.06);`; }

  function mkSingleBars(level, palette){
    const lv = clampLevel(level);
    let bars = '';
    for (let i=1;i<=10;i++){
      if (lv !== null && i <= lv){
        const col = palette[i] || palette[10] || 'rgba(31,166,122,.35)';
        bars += `<div class="gseg" style="${segStyle(col)}"></div>`;
      } else {
        bars += `<div class="gseg"></div>`;
      }
    }
    return bars;
  }

  function mkDualBars(level, palette){
    const lv = clampLevel(level) || 0;
    let bars = '';
    for (let i=1;i<=10;i++){
      if (i <= lv){
        const col = palette[i] || palette[10] || 'rgba(31,166,122,.35)';
        bars += `<div class="gseg" style="${segStyle(col)}"></div>`;
      } else bars += `<div class="gseg"></div>`;
    }
    return bars;
  }

  // ----------------------------
  // STATE CACHE + helpers
  // ----------------------------
  let lastState = null;

  // ----------------------------
// SCADA DEBUG (UI)
// ----------------------------
let debugOn = false;
let debugSource = "—";

function setDebugVisible(v){
  debugOn = !!v;
  const panel = document.getElementById("scada-debug");
  if (panel) panel.style.display = debugOn ? "block" : "none";
  if (debugOn) refreshDebugNow();
}

async function refreshDebugNow(){
  if (!debugOn) return;

  // Prefer server-side debug snapshot if available
  try{
    const r = await fetch("/debug.json", { cache:"no-store" });
    if (r.ok){
      const j = await r.json();
      paintDebug(j?.state ?? j);
      return;
    }
  } catch(e){}

  // Fallback: use last known UI payload
  if (window.__RSC_LAST) paintDebug(window.__RSC_LAST);
}

function paintDebug(stateObj){
  const pre = document.getElementById("dbg-json");
  if (pre) pre.textContent = JSON.stringify(stateObj, null, 2);

  const tsRaw = stateObj?._server_ts ?? null;
  let ts = (tsRaw === null || tsRaw === undefined) ? null : Number(tsRaw);
  if (Number.isFinite(ts) && ts < 1e12) ts = ts * 1000;

  const tsEl = document.getElementById("dbg-last-ts");
  const ageEl = document.getElementById("dbg-age");
  const srcEl = document.getElementById("dbg-path");

  if (tsEl) tsEl.textContent = `LAST TS: ${ts ? new Date(ts).toISOString() : "—"}`;

  if (ageEl){
    if (!ts){
      ageEl.textContent = "AGE: —";
      ageEl.className = "badge";
    } else {
      const ageMs = Date.now() - ts;
      const ageS = Math.round(ageMs/1000);
      ageEl.textContent = `AGE: ${ageS}s`;

      ageEl.className = "badge";
      if (ageS <= 15) ageEl.classList.add("badge-good");
      else if (ageS <= 60) ageEl.classList.add("badge-warn");
      else ageEl.classList.add("badge-bad");
    }
  }

  if (srcEl) srcEl.textContent = `SOURCE: ${debugSource || "—"}`;
}




// keep updating while visible
setInterval(() => { if (debugOn) refreshDebugNow(); }, 2000);
  
function rscRegimeDirection(cycleStr){
  const s = String(cycleStr || '').toLowerCase();

  // Real asset regime keywords
  if (s.includes('commod') || s.includes('real asset') || s.includes('hard asset') || s.includes('gold')) return 'REAL';

  // Financial asset regime keywords
  if (s.includes('financial') || s.includes('equities') || s.includes('risk-on') || s.includes('stocks')) return 'FIN';

  return null; // no regime / unknown
}

function rscClockStage(count){
  const c = Number.parseInt(count, 10);
  if (!Number.isFinite(c)) return null;
  if (c <= 0)  return 'INITIATING';
  if (c <= 25) return 'EARLY';
  if (c <= 70) return 'MID';
  if (c <= 85) return 'LATE';
  return 'END';
}
// ============================================================
// CLOCK OFFSET (UI) — Macro.py count correction
// If Macro count is +2, set -2 here.
// ============================================================
const RSC_CLOCK_OFFSET = -2;

// clamp to 0..100 (cycle clock is percentage style)
function rscApplyClockOffset(rawCount){
  const n = Number.parseInt(rawCount, 10);
  if (!Number.isFinite(n)) return null;
  const adj = n + RSC_CLOCK_OFFSET;
  return Math.max(0, Math.min(100, adj));
}

  function setText(id, txt){ const el = document.getElementById(id); if (el) el.innerText = txt; }

  function _extract6mRor(flowRaw){
    if (!flowRaw) return null;
    const s = String(flowRaw);
    const m = s.match(/6M\s*R(?:O)?R\s*[:\-]?\s*([+\-]?\d+(\.\d+)?)\s*%/i);
    if (!m) return null;
    const v = parseFloat(m[1]);
    return Number.isFinite(v) ? v : null;
  }
  function _classifyRor(r){ if (r === null) return 'UNKNOWN'; if (r < 0) return 'NEGATIVE'; if (r <= 2) return 'FLAT'; return 'RISING'; }
  function _clockBucket(count){ const c = parseInt(count, 10); if (!Number.isFinite(c)) return null; return (c <= 40) ? 'LOW' : 'HIGH'; }
  function _card2Interpretation(rorClass, clockBucket){
    if (!clockBucket) return { label:'CYCLE CLOCK PENDING', tone:'', rule:'Waiting for Cycle Clock…' };
    if (rorClass === 'UNKNOWN') return { label:'6M RoR PENDING', tone:'', rule:'Waiting for 6M RoR…' };
    if (rorClass === 'RISING'   && clockBucket === 'LOW')  return { label:'TREND CONFIRMATION', tone:'badge-good', rule:'Rising RoR + Low clock → trend confirmation.' };
    if (rorClass === 'FLAT'     && clockBucket === 'LOW')  return { label:'OPPORTUNITY / CONSOLIDATION', tone:'badge-warn', rule:'Flat/slowing RoR + Low clock → consolidation / opportunity.' };
    if (rorClass === 'NEGATIVE' && clockBucket === 'HIGH') return { label:'DISTRIBUTION RISK', tone:'badge-bad', rule:'Negative RoR + High clock → distribution risk.' };
    if (rorClass === 'FLAT'     && clockBucket === 'HIGH') return { label:'LATE CYCLE WARNING', tone:'badge-warn', rule:'Flat/slowing RoR + High clock → late-cycle warning.' };
    if (rorClass === 'RISING'   && clockBucket === 'HIGH') return { label:'LATE CYCLE — WATCH', tone:'badge-warn', rule:'Rising RoR + High clock → strong trend, but late-cycle watch.' };
    return { label:'CONTEXT ACTIVE', tone:'', rule:'Context active.' };
  }
  function _renderCard2Meta(flowRaw, count){
    const host = document.getElementById('card2-meta'); if (!host) return;
    const r = _extract6mRor(flowRaw); const rClass = _classifyRor(r); const cb = _clockBucket(count); const out = _card2Interpretation(rClass, cb);
    const rTxt = (r === null) ? '—' : (r.toFixed(2) + '%'); const cVal = parseInt(count, 10); const cTxt = Number.isFinite(cVal) ? (cVal + '%') : '—';
    const pill = out.tone ? `<span class="badge ${out.tone}">${out.label}</span>` : `<span class="badge">${out.label}</span>`;
    host.innerHTML = `
      <div><strong>6M RoR:</strong> ${rTxt} &nbsp; <strong>CYCLE CLOCK:</strong> ${cTxt}</div>
      <div style="margin-top:10px;">${pill}</div>
      <div style="margin-top:10px;opacity:.85;">${out.rule || ''}</div>`;
  }

  function hideGauge(id){ const host = document.getElementById(id); if (host){ host.style.display='none'; host.innerHTML=''; } }
  function showGauge(id, level, title, metaLines, palette){
    const host = document.getElementById(id); if (!host) return;
    const bars = mkSingleBars(level, palette || XY_COL);
    const metaHtml = (Array.isArray(metaLines) && metaLines.length) ? `<div class="gmeta">${metaLines.map(x=>`<div>${x}</div>`).join('')}</div>` : '';
    host.innerHTML = `
      <div class="gauge">
        <div class="gauge-title">${title}</div>
        <div class="gauge-bars">${bars}</div>
      </div>
      ${metaHtml}`;
    host.style.display='block';
  }
  function showDualGauge(id, buyLevel, sellLevel, title, metaLines){
    const host = document.getElementById(id); if (!host) return;
    const buyBars = mkDualBars(buyLevel, BUY_COL); const sellBars = mkDualBars(sellLevel, SELL_COL);
    const metaHtml = (Array.isArray(metaLines) && metaLines.length) ? `<div class="gmeta">${metaLines.map(x=>`<div>${x}</div>`).join('')}</div>` : '';
    host.innerHTML = `
      <div class="gauge">
        <div class="gauge-title">${title}</div>
        <div style="width:100%;">
          <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;">
            <div style="min-width:42px;font-size:10px;color:#8a8a8a;letter-spacing:2px;text-transform:uppercase;">BUY</div>
            <div class="gauge-bars">${buyBars}</div>
          </div>
          <div style="display:flex;align-items:center;gap:10px;">
            <div style="min-width:42px;font-size:10px;color:#8a8a8a;letter-spacing:2px;text-transform:uppercase;">SELL</div>
            <div class="gauge-bars">${sellBars}</div>
          </div>
        </div>
      </div>
      ${metaHtml}`;
    host.style.display='block';
  }

  // ----------------------------
  // SECRET MODE
  // ----------------------------
  // ----------------------------
// FOUNDER SESSION GATE
// ----------------------------

const FOUNDER_KEY = "SH_FOUNDER_UNLOCKED"; // session-only

function isFounderUnlocked(){
  return sessionStorage.getItem(FOUNDER_KEY) === "1";
}

function setFounderUnlocked(v){
  if (v) sessionStorage.setItem(FOUNDER_KEY, "1");
  else sessionStorage.removeItem(FOUNDER_KEY);
  founderMode = !!v; // <-- keep in sync
}

// boot: set founderMode from session storage
setFounderUnlocked(isFounderUnlocked());
_updateDebugBtn();

// ----------------------------
// VAULT VIEW (UI MODE)
// ----------------------------

// ----------------------------
// DEBUG BUTTON (secret + shift only)
// ----------------------------


function _updateDebugBtn() {
  if (typeof secretMode === "undefined") return;

  const btn = document.getElementById("dbg-toggle");
  if (!btn) return;

  btn.style.display = secretMode ? "block" : "none";
}





// click → open debug page in a new tab
(function wireDebugBtn(){
  const btn = document.getElementById('dbg-toggle');
  if (!btn) return;
  btn.addEventListener('click', () => {
    window.open('/debug', '_blank', 'noopener');
  });
})();


  function enableSecretMode(){
  setFounderUnlocked(true);   // <-- ADD THIS
  secretMode = true;
  _updateDebugBtn();  

  const exitBtn = document.getElementById('vault-exit'); 
  if (exitBtn) exitBtn.style.display = 'inline-flex';

  setText('h3-1', 'Institutional X'); 
  setText('h3-2', 'Institutional Y'); 
  setText('h3-3', 'Institutional Buyers / Sellers');

  ['card-1','card-2','card-3'].forEach(id => { 
    const c = document.getElementById(id); 
    if (c) c.className = 'card halo-bg-secret'; 
  });

  const t3 = document.getElementById('track-3'); 
  if (t3) t3.style.display = 'none';

  if (lastState) applySecretFromState(lastState);
}

  function closeVault(){
    
    const exitBtn = document.getElementById('vault-exit'); if (exitBtn) exitBtn.style.display = 'none';
    hideGauge('gauge-1'); hideGauge('gauge-2'); hideGauge('gauge-3');
    setText('h3-1','Regime & Volatility'); setText('h3-2','Capital Rotation'); setText('h3-3','CYCLE CLOCK');
    if (lastState) applyPublicFromState(lastState); else applyPublicFromState({});
    _updateDebugBtn();
  }
  function applyFounderHaze(dir){
    const c3 = document.getElementById('card-3');
    if (!c3) return;

    // always clean first
    c3.classList.remove('haze-gold','haze-steel');

    if (!founderMode || !dir) return;

    if (dir === 'REAL') c3.classList.add('haze-gold');
    if (dir === 'FIN')  c3.classList.add('haze-steel');
   }
  
  window.closeVault = closeVault;

  function setWarBadge(active){
    const badge = document.getElementById('war-badge'); if (!badge) return;
    badge.style.display = (!secretMode && active) ? 'inline-flex' : 'none';
  }

  // ----------------------------
  // PUBLIC APPLY
  // ----------------------------
 function applyPublicFromState(data){
  const warActive = !!(data?.secret?.war?.active);
  document.body.classList.toggle('war-room', warActive);
  setWarBadge(warActive);

  // ---------- reset ----------
  ['card-1','card-2','card-3'].forEach(id => {
    const c = document.getElementById(id);
    if (c) c.className = 'card';
  });

  setText('val-1','AWAITING'); setText('sub-1','');
  setText('val-2','SHORT-TERM PREFERENCE REMAINS'); setText('val-2b','UNCLEAR — MONITORING');
  setText('val-3','AWAITING'); setText('sub-3','');

  const t3 = document.getElementById('track-3');
  const fill3 = document.getElementById('fill-3');
  if (t3) t3.style.display = 'none';
  if (fill3) { fill3.style.width = '0%'; fill3.style.background = 'var(--gold)'; }

    // ============================================================
  // CARD 1 — REGIME + VOL (MATCH CARD 3 COLOUR STANDARD)
  // REAL  -> halo-bg-gold
  // FIN   -> halo-bg-steel
  // else  -> halo-bg-silver
  // ============================================================
  {
    const v1 = document.getElementById('val-1');
    const s1 = document.getElementById('sub-1');
    const c1 = document.getElementById('card-1');

    const cycleRaw = String(data?.cycle || '').trim();
    const dir = rscRegimeDirection(cycleRaw); // 'REAL' | 'FIN' | null

    if (v1){
      if (!cycleRaw){
        v1.innerText = 'AWAITING';
      } else if (dir === 'REAL'){
        v1.innerText = 'REAL ASSET REGIME';
      } else if (dir === 'FIN'){
        v1.innerText = 'FINANCIAL ASSET REGIME';
      } else {
        v1.innerText = cycleRaw.toUpperCase();
      }
      // headline stays white; halo carries colour
      v1.style.color = 'var(--text)';
    }

    if (c1){
      c1.className = 'card';
      if (dir === 'REAL') c1.classList.add('halo-bg-gold');
      else if (dir === 'FIN') c1.classList.add('halo-bg-steel');
      else c1.classList.add('halo-bg-silver');
    }

    // volatility line (keep your existing behaviour)
    if (data?.vol){
      const vol = String(data.vol).toUpperCase();
      if (s1){
        s1.innerText = `VOLATILITY: ${vol}`;
        s1.style.color = (vol === 'ELEVATED') ? 'var(--red)' : 'var(--lime)';
      }
    } else {
      if (s1) { s1.innerText = ''; s1.style.color = 'var(--text)'; }
    }
  }


  // ============================================================
  // CARD 3 — CYCLE CLOCK (REGIME + STAGE + COLOR)
  // Requires: rscClockStage(count) and rscRegimeDirection(data.cycle)
  // ============================================================
  if (data?.count === undefined || data?.count === null) return;

  const count = rscApplyClockOffset(data.count); // ✅ OFFSET APPLIED
  if (count === null) return;


  const v3 = document.getElementById('val-3');
  const s3 = document.getElementById('sub-3');
  const c3 = document.getElementById('card-3');
  const t3b = document.getElementById('track-3');
  const f3b = document.getElementById('fill-3');

  // bar
  if (t3b) t3b.style.display = 'block';
  if (f3b) f3b.style.width = `${count}%`;
  if (s3)  s3.innerText = `MATURITY: ${count}%`;

  const stage = rscClockStage(count) || 'INITIATING';
  const dir = rscRegimeDirection(data?.cycle); // 'REAL' | 'FIN' | null
  applyFounderHaze(dir);
  let headline = `NO REGIME → ${stage}`;
  let cardClass = 'card halo-bg-silver';
  let fillCol = 'var(--silver)';

  if (dir === 'REAL'){
    headline = `REAL ASSET REGIME → ${stage}`;
    cardClass = 'card halo-bg-gold';
    fillCol = 'var(--gold)';
  } else if (dir === 'FIN'){
    headline = `FINANCIAL ASSET REGIME → ${stage}`;
    cardClass = 'card halo-bg-steel';
    fillCol = 'var(--steel)';
  }

  // late/end overlays dominate regime color
  if (count >= 86){
    cardClass = 'card glow-danger';
    fillCol = 'var(--red)';
  } else if (count >= 71){
    cardClass = 'card glow-warning';
    fillCol = 'var(--orange)';
  }

  if (v3){
    v3.innerText = headline;
    v3.style.color = (count >= 71) ? fillCol : 'var(--text)';
  }
  if (c3) c3.className = cardClass;
  if (f3b) f3b.style.background = fillCol;
}
  // ----------------------------
  // SECRET APPLY (unchanged)
  // ----------------------------
  function applySecretFromState(data){
    const secret = (data && data.secret) ? data.secret : {};
    const vix = secret.vix || {}; const gvz = secret.gvz || {}; const buy = secret.buy || {}; const sell = secret.sell || {}; const vold = secret.vold || {};
    const warActive = !!(secret && secret.war && secret.war.active);
    document.body.classList.toggle('war-room', warActive); setWarBadge(false);

    const v1 = document.getElementById('val-1'); const s1 = document.getElementById('sub-1'); const v2 = document.getElementById('val-2'); const s2 = document.getElementById('sub-2'); const v3 = document.getElementById('val-3'); const s3 = document.getElementById('sub-3');

    const xVal = (vix.value !== null && vix.value !== undefined) ? (String(vix.value) + '%') : '—';
    setText('val-1', xVal); setText('sub-1', vix.state ? vix.state : 'AWAITING SIGNAL'); if (v1) v1.style.color = 'var(--text)'; if (s1) s1.style.color = 'var(--text)';
    showGauge('gauge-1', vix.level, 'LEVEL', [`<strong>Institutional X</strong>`, `LEVEL: ${vix.level ?? '—'}${(vix.level && vix.level <= 4) ? ' • WAR ROOM' : ''}`], XY_COL);

    const yVal = (gvz.value !== null && gvz.value !== undefined) ? (String(gvz.value) + '%') : '—';
    setText('val-2', yVal); setText('sub-2', gvz.state ? gvz.state : 'AWAITING SIGNAL'); if (v2) v2.style.color = 'var(--text)'; if (s2) s2.style.color = 'var(--text)';
    showGauge('gauge-2', gvz.level, 'LEVEL', [`<strong>Institutional Y</strong>`, `LEVEL: ${gvz.level ?? '—'}${(gvz.level && (gvz.level <= 3 || gvz.level >= 8)) ? ' • WAR ROOM' : ''}`], XY_COL);

    const buyVal  = (buy.value  !== null && buy.value  !== undefined) ? String(buy.value)  : '—';
    const sellVal = (sell.value !== null && sell.value !== undefined) ? String(sell.value) : '—';
    setText('val-3', `BUY ${buyVal} / SELL ${sellVal}`);
    setText('sub-3', `${(buy.state || 'BUYING')} • ${(sell.state || 'SELLING')}${vold.state ? (' • ' + vold.state) : ''}`.trim());
    if (v3) v3.style.color = 'var(--text)'; if (s3) s3.style.color = 'var(--text)';

    const buyL  = Number.isFinite(buy.level) ? buy.level : 0;
    const sellL = Number.isFinite(sell.level) ? sell.level : 0;
    showDualGauge('gauge-3', buyL, sellL, 'PRESSURE', [`<strong>Institutional Buyers / Sellers</strong>`, `BUY_L: ${buy.level ?? '—'} • SELL_L: ${sell.level ?? '—'}`]);
  }

  // ----------------------------
  // MONITORING STATE APPLY (unchanged)
  // ----------------------------
  function applyMonitoringFromState(data){
    const m = data && data.monitor ? data.monitor : {};
    const ticker   = (m.ticker || '').toUpperCase();
    const trigger  = (m.trigger || '').toUpperCase();
    const status   = m.status || '';
    const setup    = m.setup;
    const trend    = (m.trend || '').toUpperCase();
    const strategy = (m.strategy || '').toUpperCase();
    const updated  = m.updated || '';

    const tickerEl = document.getElementById('mon-ticker');
    const trigEl   = document.getElementById('mon-trigger');
    const statusEl = document.getElementById('mon-status');
    if (tickerEl) tickerEl.innerText = ticker || 'NO SYMBOL';
    if (trigEl)   trigEl.innerText   = `TRIGGER: ${trigger || '—'}`;
    if (statusEl) statusEl.innerText = status || 'AWAITING — NO ACTIVE MONITORING';

    const setupEl = document.getElementById('mon-setup');
    if (setupEl){ setupEl.className = 'badge'; if (setup === true || setup === 'ON'){ setupEl.classList.add('badge-warn'); setupEl.innerText = 'SETUP: ACTIVE'; } else { setupEl.innerText = 'SETUP: INACTIVE'; } }

    const trendEl = document.getElementById('mon-trend');
    if (trendEl){ trendEl.className = 'badge'; if (trend === 'ALIGNED'){ trendEl.classList.add('badge-good'); trendEl.innerText = 'TREND: ALIGNED'; } else if (trend === 'MISALIGNED'){ trendEl.classList.add('badge-bad'); trendEl.innerText = 'TREND: MISALIGNED'; } else { trendEl.innerText = 'TREND: —'; } }

    const stratEl = document.getElementById('mon-strategy'); if (stratEl){ stratEl.className = 'badge'; stratEl.innerText = `STRATEGY: ${strategy || '—'}`; }
    const updEl   = document.getElementById('mon-updated');  if (updEl){   updEl.innerText   = `UPDATED: ${updated || '—'}`; }

    const card = document.getElementById('monitor-card');
    if (card){
      card.className = 'card card-wide';
      const setupOn = (setup === true || setup === 'ON');
      if (setupOn && trend === 'ALIGNED') card.classList.add('glow-lime');
      if (trend === 'MISALIGNED')          card.classList.add('glow-danger');
      if (setupOn && trend !== 'ALIGNED')  card.classList.add('glow-warning');
    }
  }
  function applyMessageFromState(data){
  const dir = rscRegimeDirection(data?.cycle); // 'REAL' | 'FIN' | null
  const m = (data && data.monitor) ? data.monitor : {};

  const headlineEl = document.getElementById('msg-headline');
  const subEl      = document.getElementById('msg-subline');

  const bReg = document.getElementById('msg-regime');
  const bSet = document.getElementById('msg-setup');
  const bSig = document.getElementById('msg-signal');
  const bObs = document.getElementById('msg-observe');

  const card = document.getElementById('msg-card');

  // helpers
  const setBadge = (el, text, tone) => {
    if (!el) return;
    el.className = 'badge';
    if (tone) el.classList.add(tone);
    el.innerText = text;
  };

  const setupOn = (m.setup === true || String(m.setup || '').toUpperCase() === 'ON');
  const trigRaw = String(m.trigger || '').trim();
  const hasSignal = trigRaw.length > 0 && trigRaw !== '—';

  const ticker = String(m.ticker || '').toUpperCase();

  // Default: neutral, no fanfare
  if (card){
    card.className = 'card card-wide halo-bg-silver';
  }

  // 1) WAITING — REGIME
  if (!dir){
    if (headlineEl) headlineEl.innerText = 'WAITING — REGIME STATE';
    if (subEl) subEl.innerText = 'Direction not confirmed. No action.';
    setBadge(bReg, 'WAITING — REGIME', 'badge-warn');
    setBadge(bSet, 'WAITING — SETUP', '');
    setBadge(bSig, 'WAITING — SIGNAL', '');
    setBadge(bObs, 'OBSERVE: —', '');
    return;
  }

  // Regime confirmed (direction is known)
  const dirText = (dir === 'REAL') ? 'REAL ASSET REGIME' : 'FINANCIAL ASSET REGIME';

  setBadge(bReg, `REGIME: ${dirText}`, 'badge-good');

  // Founder-only: subtle haze behind message card (no action implication)
  // Uses your existing halo classes (direction only)
  if (founderMode && card){
    if (dir === 'REAL') card.className = 'card card-wide halo-bg-gold';
    if (dir === 'FIN')  card.className = 'card card-wide halo-bg-steel';
  }

  // 2) WAITING — SETUP
  if (!setupOn){
    if (headlineEl) headlineEl.innerText = 'WAITING — SETUP STATE';
    if (subEl) subEl.innerText = 'Direction confirmed. Setup not active.';
    setBadge(bSet, 'WAITING — SETUP', 'badge-warn');
    setBadge(bSig, 'WAITING — SIGNAL', '');
    setBadge(bObs, 'OBSERVE: —', '');
    return;
  }

  setBadge(bSet, 'SETUP: ACTIVE', 'badge-good');

  // 3) WAITING — SIGNAL
  if (!hasSignal){
    if (headlineEl) headlineEl.innerText = 'WAITING — SIGNAL STATE';
    if (subEl) subEl.innerText = 'Setup active. Waiting for trigger.';
    setBadge(bSig, 'WAITING — SIGNAL', 'badge-warn');
    setBadge(bObs, ticker ? `OBSERVE: ${ticker}` : 'OBSERVE: WATCHLIST', '');
    return;
  }

  // 4) SIGNAL DETECTED (still not action; “observe stock cards”)
  if (headlineEl) headlineEl.innerText = 'SIGNAL STATE DETECTED — OBSERVE STOCK CARDS';
  if (subEl) subEl.innerText = ticker ? `${ticker} • Trigger: ${trigRaw}` : `Trigger: ${trigRaw}`;
  setBadge(bSig, `SIGNAL: ${trigRaw}`, 'badge-good');
  setBadge(bObs, ticker ? `OBSERVE: ${ticker}` : 'OBSERVE: STOCK CARDS', 'badge-warn');
}

  /* === RSC MOCK MODE (REMOVE LATER) === */
  window.RSC_MOCK = false;
  function emitMockMacro(payload){
    if (!window.RSC_MOCK) return;
    console.log("[RSC MOCK]", payload);
    if (typeof window.handleMacroUpdate === "function") window.handleMacroUpdate(payload);
    else applyAllFromState(payload);
  }

  // ----------------------------
  // SOCKET.IO
  // ----------------------------
  let socket = null;
  try{
    if (window.io){
      socket = io({ transports:['polling','websocket'], upgrade:true, reconnection:true });
      socket.on('connect', () => {
        console.log('CONNECTED');
      const el = document.getElementById("dbg-socket");
      if (el){
        el.textContent = "SOCKET: CONNECTED";
        el.className = "badge badge-good";
      }
    });
      socket.on('connect_error', (e) => {
        console.log('SOCKET ERROR', e);
        const el = document.getElementById("dbg-socket");
        if (el){
          el.textContent = "SOCKET: ERROR";
          el.className = "badge badge-bad";
      }
    });
    } else {
      console.log('Socket.IO not loaded; clock will still run.');
    }
  } catch(e){
    console.log('Socket init failed; clock will still run.', e);
  }
  function setTerminalStatus(mode){
  const dot  = document.getElementById('term-dot');
  const text = document.getElementById('term-text');
  if (!dot || !text) return;

  // reset
  dot.style.boxShadow = '';
  dot.style.background = '';
  text.style.color = '';

  if (mode === 'OK'){
    dot.style.background = 'var(--lime)';
    dot.style.boxShadow = '0 0 10px var(--lime)';
    text.textContent = 'TERMINAL ACTIVE';
    text.style.color = 'var(--lime)';
    return;
  }

  if (mode === 'WARN'){
    dot.style.background = 'var(--orange)';
    dot.style.boxShadow = '0 0 10px var(--orange)';
    text.textContent = 'TERMINAL STALE';
    text.style.color = 'var(--orange)';
    return;
  }

  // OFFLINE
  dot.style.background = 'var(--red)';
  dot.style.boxShadow = '0 0 10px var(--red)';
  text.textContent = 'TERMINAL OFFLINE';
  text.style.color = 'var(--red)';
}
  
  // ============================================================
// SCADA COMMS (AGE / SOURCE / LAST)
// ============================================================
function rscSetComms(source, payload){
  const elAge  = document.getElementById('scada-age');
  const elSrc  = document.getElementById('scada-source');
  const elLast = document.getElementById('scada-last');
  const wrap   = document.getElementById('scada-comms');
  if (!elAge || !elSrc || !elLast) return;

  // ---- normalize common server shapes ----
  let p = payload;
  if (p && typeof p === "object") {
    if (p.state && typeof p.state === "object") p = p.state;
    else if (p.payload && typeof p.payload === "object") p = p.payload;
    else if (p.data && typeof p.data === "object") p = p.data;
  }

  // ---- read ts (seconds or ms) ----
  let ts = (p && p._server_ts != null) ? Number(p._server_ts) : null;
  if (Number.isFinite(ts) && ts < 1e12) ts *= 1000; // seconds -> ms
    const term = document.getElementById('terminal-line');
    if (term) term.style.display = 'inline-flex';
  // Always show source even if ts missing
  elSrc.textContent = `SOURCE: ${source || '—'}`;

if (!Number.isFinite(ts)){
  elLast.textContent = `LAST: —`;
  elAge.textContent  = `AGE: —`;
  setTerminalStatus('OFFLINE');     // <--- ADD
  return;
}

  const dt = new Date(ts);
  elLast.textContent = `LAST: ${dt.toISOString()}`;

 const tick = () => {
  const s = Math.max(0, Math.floor((Date.now() - ts) / 1000));
  elAge.textContent = `AGE: ${s}s`;

  // status logic
  if (s <= 1200) setTerminalStatus('OK');
  else if (s <= 4500) setTerminalStatus('WARN');
  else setTerminalStatus('OFFLINE');
};
  tick();

  clearInterval(window.__RSC_AGE_TMR);
  window.__RSC_AGE_TMR = setInterval(tick, 1000);

  if (wrap){
    wrap.classList.add('flash');
    setTimeout(() => wrap.classList.remove('flash'), 250);
  }
}

 
function applyAllFromState(data) {
  lastState = data || {};

  // --- WAR badge (unchanged) ---
  const warActive = !!(data && data.secret && data.secret.war && data.secret.war.active);
  setWarBadge(warActive);

  // --- Existing render lanes (unchanged) ---
  if (!secretMode) applyPublicFromState(data);
  else applySecretFromState(data);

  applyMonitoringFromState(data);
  applyMessageFromState(data);

   // ============================================================
  // CARD 2 — SHORT-TERM BIAS (clean UI + aligned glow copy)
  // - Main line fixed: "SHORT-TERM PREFERENCE REMAINS" (white)
  // - Status line below: CONSISTENT / WEAKNESS / UNCLEAR (coloured, small)
  // - Glow rule: ONLY if Card2 thesis aligns with Card1 capital flow thesis
  // ============================================================
  (function applyCard2FromState() {
    const c2  = document.getElementById("card-2");
    const v2  = document.getElementById("val-2");   // big line
    const v2b = document.getElementById("val-2b");  // small status line
    const c1  = document.getElementById("card-1");  // used to copy glow-*

    if (!c2 || !v2 || !v2b) return;

    // Always enforce clean headline
    v2.textContent = "SHORT-TERM PREFERENCE REMAINS";

    // ---------- Read Card2 state (server shapes can vary)
    const isStandaloneCard2 = String(data?.type || "").toUpperCase() === "CARD2";

    const card2Obj = (data && typeof data.card2 === "object" && data.card2) ? data.card2 : null;

    // Accept BOTH:
    // (A) full STATE objects that contain card2_* fields
    // (B) standalone TradingView payloads: {type:"CARD2", state:"GREEN", text:"..."}
    const card2StateRaw =
      (isStandaloneCard2 ? data?.state : null) ??
      (data && (data.card2_state ?? data.card2State ?? null)) ??
      (card2Obj && (card2Obj.state ?? card2Obj.card2_state ?? null)) ??
      null;

    const card2TextRaw =
      (isStandaloneCard2 ? data?.text : null) ??
      (data && (data.card2_text ?? data.card2Text ?? null)) ??
      (card2Obj && (card2Obj.text ?? card2Obj.card2_text ?? null)) ??
      (typeof data?.card2 === "string" ? data.card2 : null) ??
      null;

    const s2 = String(card2StateRaw ?? "").toUpperCase();
    const t2 = String(card2TextRaw ?? "").toUpperCase();

    // ---------- Read Card1 thesis (Macro/Regime) for alignment
   // ---------- Read Card1 thesis (use canonical state key: data.cycle)
    const t1 = String(data?.cycle ?? "").toUpperCase();

    // ---------- Determine "thesis" buckets (FINANCIAL vs REAL_ASSET)
    // Card1 thesis (macro flow)
    const card1Thesis =
      (t1.includes("REAL") || t1.includes("COMMOD") || t1.includes("GOLD") || t1.includes("COPPER"))
        ? "REAL_ASSET"
        : (t1.includes("FINANCIAL") || t1.includes("EQUIT") || t1.includes("RISK") || t1.includes("STOCK"))
          ? "FINANCIAL"
          : "UNKNOWN";

    // Card2 thesis (short-term flow) – from text/state if present
    const card2Thesis =
      (t2.includes("REAL") || t2.includes("COMMOD") || t2.includes("GOLD") || t2.includes("COPPER") || s2.includes("REAL"))
        ? "REAL_ASSET"
        : (t2.includes("FINANCIAL") || t2.includes("EQUIT") || t2.includes("RISK") || s2.includes("FIN") || s2.includes("EQUIT"))
          ? "FINANCIAL"
          : "UNKNOWN";

    const aligned =
      card1Thesis !== "UNKNOWN" &&
      card2Thesis !== "UNKNOWN" &&
      card1Thesis === card2Thesis;

    // ---------- Status line content + colour (independent of glow)
    let statusText = "UNCLEAR — MONITORING";
    let cls = "card2-neutral";

    // If Pine provides explicit GREEN/RED we respect it for the status line text,
    // but GLOW only happens when aligned with Card1.
    if (s2 === "GREEN" || s2 === "LIME" || s2 === "BULL" || s2 === "ALIGNED") {
      statusText = "CONSISTENT WITH MACRO CONDITIONS";
      cls = "card2-green";
    } else if (s2 === "RED" || s2 === "BEAR" || s2 === "DIVERGE" || s2 === "WEAK") {
      statusText = "WEAKNESS AGAINST MACRO CONDITIONS";
      cls = "card2-red";
    } else {
      statusText = "UNCLEAR — MONITORING";
      cls = "card2-neutral";
    }

    v2b.textContent = statusText;
    v2b.classList.remove("card2-green","card2-red","card2-neutral");
    v2b.classList.add(cls);

  // ---------- HALO rule (Card2 inherits MACRO halo when Card2 is CONSISTENT)
  const dir = rscRegimeDirection(data?.cycle); // REAL | FIN | null

  // consistent states (you already use these for status line)
  const isConsistent =
    (s2 === "GREEN" || s2 === "LIME" || s2 === "BULL" || s2 === "ALIGNED");

  // hard reset
  c2.className = "card";
  c2.classList.remove("glow-lime","glow-warning","glow-danger","halo-bg-secret");
  if (isConsistent) {
    if (dir === "REAL") c2.classList.add("halo-bg-gold");
    else if (dir === "FIN") c2.classList.add("halo-bg-steel");
    else c2.classList.add("halo-bg-silver");
  } else {
    c2.classList.add("halo-bg-silver");
  }

  // keep CSS in charge
  c2.style.borderColor = "";
  c2.style.boxShadow = "";



    // ---------- HARD CLEANUP: remove/hide any old/legacy Card2 extra elements if present
    const legacyIds = ["val-2-sub", "val2-sub", "ror-2", "ror2", "card2-ror", "card2-note"];
    legacyIds.forEach(id => {
      const el = document.getElementById(id);
      if (el) el.style.display = "none";
    });

    const maybeTextNodes = c2.querySelectorAll("div,span,p");
    maybeTextNodes.forEach(el => {
      const txt = (el.textContent || "").toUpperCase();
      if (txt.includes("ROR") || txt.includes("6M")) {
        if (el.id !== "val-2" && el.id !== "val-2b") el.style.display = "none";
      }
    });

  })();
  // ============================================================
  // CARD 4 — RECESSION PULSE (LOCKED v1)
  // Sahm Rule:
  // < 0.35  = EXPANSION
  // 0.35–0.49 = STALLING
  // >= 0.50 = CONTRACTION
  // Contraction shows Market Weakness (SPX DD → 35%)
  // Observational only
  // ============================================================

  (function applyCard4FromState() {
    if (!(data && data.sahm != null)) return;

    const s = Number(data.sahm);
    if (!Number.isFinite(s)) return;

    const v4   = document.getElementById("val-4");
    const c4   = document.getElementById("card-4");
    const node = document.getElementById("led-node");

    const mwWrap = document.getElementById("mw-wrap");
    const mwFill = document.getElementById("mw-fill");
    const mwVal  = document.getElementById("mw-val");
    const mwNote = document.getElementById("mw-note");

    // reset
    if (mwWrap) mwWrap.style.display = "none";
    if (mwNote) mwNote.style.display = "none";
    if (mwFill) mwFill.style.height = "0%";
    window.__S3_ARMED = false;

    // -------- EXPANSION --------
    if (s < 0.35) {
      if (v4) v4.innerText = "Economic:EXPANSION";
      if (c4) c4.className = "card glow-lime";
      if (node) {
        node.className = "pulse-node pulse-slow";
        node.style.background = "var(--lime)";
        node.style.boxShadow = "0 0 40px var(--lime)";
      }
      return;
    }

    // -------- STALLING --------
    if (s < 0.50) {
      if (v4) v4.innerText = "Economy:STALLING";
      if (c4) c4.className = "card glow-warning";
      if (node) {
        node.className = "pulse-node pulse-mid";
        node.style.background = "var(--orange)";
        node.style.boxShadow = "0 0 40px var(--orange)";
      }
      return;
    }

    // -------- CONTRACTION --------
    if (v4) v4.innerText = "Economic:CONTRACTION";
    if (c4) c4.className = "card glow-danger";
    if (node) {
      node.className = "pulse-node pulse-fast";
      node.style.background = "var(--red)";
      node.style.boxShadow = "0 0 60px var(--red)";
    }

    // -------- MARKET WEAKNESS --------
    if (mwWrap) mwWrap.style.display = "flex";

    let dd =
      data.spx_dd ??
      data.spxDrawdown ??
      data.spx_dd_pct ??
      data.dd ??
      data.drawdown ??
      null;

    // dd can arrive as a string sometimes ("12.3")
    if (typeof dd === "string") dd = Number(dd);

    if (typeof dd !== "number" || !Number.isFinite(dd)) {
      if (mwVal) mwVal.innerText = "SPX DD: —";
      if (mwNote) {
        mwNote.style.display = "block";
        mwNote.innerText = "MARKET WEAKNESS: PENDING";
      }
      return;
    }

    dd = Math.abs(dd);
    if (dd <= 1) dd *= 100; // allow 0.12 or 12

    const CAP = 35;
    const clipped = Math.min(CAP, dd);
    const pct = Math.round((clipped / CAP) * 100);

    if (mwFill) mwFill.style.height = pct + "%";
    if (mwVal)  mwVal.innerText = `SPX DD: ${dd.toFixed(1)}%`;

    if (dd >= CAP) {
      window.__S3_ARMED = true;
      if (mwNote) {
        mwNote.style.display = "block";
        mwNote.innerText = "MARKET WEAKNESS THRESHOLD ACHIEVED";
      }
    } else {
      if (mwNote) {
        mwNote.style.display = "block";
        mwNote.innerText = "MARKET WEAKNESS TRACKING";
      }
    }
  })();
} // ✅ CLOSE applyAllFromState()

window.applyAllFromState = applyAllFromState;



   // ============================================================
  // VALIDATOR + SINGLE ENTRY POINT (FREEZE)
  // ============================================================
  function rscValidateMacro(p){
    if (!p || typeof p !== "object") return { ok:false, why:"payload_not_object" };

    // tolerate server timestamp in SECONDS or MILLISECONDS
    if (p._server_ts !== undefined && p._server_ts !== null){
      let ts = Number(p._server_ts);
      if (Number.isFinite(ts)){
        // if it's seconds (10 digits-ish), convert to ms
        if (ts < 1e12) ts = ts * 1000;

        const ageMs = Date.now() - ts;
         console.log("[TS DEBUG]", { now: Date.now(), _server_ts: p._server_ts, ageMs: Date.now() - p._server_ts });
        // if clock skew puts it in the future, don't drop it
        if (ageMs > 30 * 60 * 1000) return { ok:false, why:`stale_${Math.round(ageMs)}ms` };
      }
    }

    return { ok:true };
  }

  console.log("✅ RSC VALIDATOR LIVE v1");
  console.log("BUILD_STAMP_ABC123");
window.addEventListener("DOMContentLoaded", () => {
  _updateDebugBtn();
});



// ============================================================
// HANDLE MACRO UPDATE — unified + resilient
// ============================================================
window.handleMacroUpdate = function(payload){
  // ---- normalize common server shapes ----
  let p = payload;

  if (p && typeof p === "object") {
    if (p.state && typeof p.state === "object") p = p.state;
    else if (p.payload && typeof p.payload === "object") p = p.payload;
    else if (p.data && typeof p.data === "object") p = p.data;
  }

  try {
    const v = rscValidateMacro(p);
    if (!v.ok){
      console.warn("[RSC DROP]", v.why, p);
      return;
    }
  } catch(e) {
    console.warn("[RSC WARN] validator error, proceeding", e);
  }

  // store + paint
  window.__RSC_LAST = p;
  console.log("[RSC HANDLE OK]", p);

  if (typeof window.applyAllFromState === "function") {
    window.applyAllFromState(p);
  } else if (typeof applyAllFromState === "function") {
    applyAllFromState(p);
  } else {
    console.warn("[RSC WARN] applyAllFromState missing — UI not painted yet");
  }
};
  // ============================================================
  // ROUTE ALL LIVE DATA THROUGH ENTRY POINT
  // ============================================================
  if (socket){
   socket.on('macro_update', (data) => {
  triggerPulse();

  // Let the canonical handler normalize + paint
  if (typeof window.handleMacroUpdate === "function") window.handleMacroUpdate(data);
  else applyAllFromState(data);

  // Use the normalized last payload if available
  const p = window.__RSC_LAST || data;
  rscSetComms("socket.io macro_update", p);

  if (debugOn) refreshDebugNow();
});
    }

  // ============================================================
  // WARM START (HEALTH)
  // ============================================================
  (async function warmStart(){
    try{
      const r = await fetch('/health', { cache:'no-store' });
      debugSource = "warmstart /health";
      if (!r.ok) return;
      const j = await r.json();
      if (j && j.state){
         rscSetComms("warmstart /health", j.state);

        if (typeof window.handleMacroUpdate === "function") window.handleMacroUpdate(j.state);
        else applyAllFromState(j.state);
      }
    } catch(e){}
  })();

  // ============================================================
  // PASSWORD MODAL
  // ============================================================
  const tor = document.getElementById('city-tor');
  if (tor){
    tor.addEventListener('dblclick', () => {
  // If already unlocked this session, skip password prompt
  if (isFounderUnlocked()){
    enableSecretMode();
    return;
  }

  const modal = document.getElementById('password-modal');
  const input = document.getElementById('pass-input');
  if (modal) modal.style.display = 'flex';
  if (input) input.focus();
});

  }

  function closeModal(){
    const modal = document.getElementById('password-modal');
    const input = document.getElementById('pass-input');
    if (modal) modal.style.display = 'none';
    if (input) input.value = '';
  }
  window.closeModal = closeModal;

  async function checkPass(){
    const input = document.getElementById('pass-input');
    const pwd = input ? input.value : '';
    try{
      const r = await fetch('/verify_secret', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ password: pwd })
      });
      closeModal();
      if (r.ok) enableSecretMode();
    } catch(e){
      closeModal();
    }
  }
  window.checkPass = checkPass;

  const passInput = document.getElementById('pass-input');
  if (passInput){
    passInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') checkPass();
    });
  }
</script>
</body>
</html>
