  <!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sutton House | Master Terminal</title>

  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

  <style>
    :root{
      --bg:#050505; --card:#111111; --text:#ffffff;
      --dim:#333333; --lime:#32CD32; --gold:#BF953F; --silver:#C0C0C0;
      --pink:#FF69B4; --red:#ff4444; --orange:#ff8c00;

      --secret:#1fa67a;
      --secret-bg-1:#0b1512;
      --secret-bg-2:#0f2a21;

      --war-1:#12080a;
      --war-2:#061313;

      --gseg-off:#1b1b1b;
      --gseg-off-b:#242424;
    }


    body{
    
      background:var(--bg); color:var(--text);
      font-family:Inter,system-ui,sans-serif;
      margin:0; padding:40px;
      display:flex; flex-direction:column; gap:40px;
      min-height:100vh; box-sizing:border-box;
      overflow-x:hidden;
      transition:background .35s ease;
     
    }

    body.war-room{
      background:
        radial-gradient(1100px 700px at 15% 10%, rgba(255,68,68,.10), transparent 55%),
        radial-gradient(900px 600px at 85% 25%, rgba(31,166,122,.10), transparent 55%),
        linear-gradient(145deg, var(--war-1), var(--war-2));
    }

    .header{
      display:flex; justify-content:space-between; align-items:center;
      border-bottom:1px solid #222; padding-bottom:30px;
    }
    .logo-area{ display:flex; align-items:center; gap:15px; }
    .logo-img{ height:70px; width:auto; }

    .gleam{
      font-weight:800; font-size:32px; letter-spacing:3px; margin:0;
      background:linear-gradient(to right,#BF953F 0%,#FCF6BA 25%,#B38728 50%,#FBF5B7 75%,#AA771C 100%);
      background-size:200% auto;
      -webkit-background-clip:text; -webkit-text-fill-color:transparent;
      animation:shine 5s linear infinite;
    }
    @keyframes shine{ to { background-position:200% center; } }

    .brand-bottom{
      display:flex; align-items:center; gap:10px; margin-top:5px;
      color:#fff; font-size:11px; text-transform:uppercase;
      letter-spacing:1.5px; font-weight:300;
    }
    .status-dot-active{
      width:5px; height:5px; border-radius:50%;
      background:var(--lime); box-shadow:0 0 10px var(--lime);
      animation:pulse-lime 2s infinite;
    }
    @keyframes pulse-lime{ 0%{opacity:1} 50%{opacity:.4} 100%{opacity:1} }

    #digital-clock{ font-size:52px; font-weight:700; text-align:right; letter-spacing:-2px; line-height:1; }
    .city-grid{ display:flex; gap:18px; margin-top:12px; justify-content:flex-end; }
    .city-item{ font-size:10px; color:#fff; display:flex; align-items:center; gap:6px; font-weight:700; cursor:pointer; transition:color .3s; }
    .status-dot{ width:6px; height:6px; background:#fff; border-radius:50%; transition:.3s; }

    .city-open{ color:var(--lime) !important; }
    .city-open .status-dot{ background:var(--lime) !important; box-shadow:0 0 12px var(--lime); }
    .comms-flash{ color:var(--pink) !important; transition:.1s; }

    .macro-header{
      font-size:14px; font-weight:700; color:#555;
      text-transform:uppercase; letter-spacing:4px;
      margin-bottom:-20px; border-left:3px solid var(--gold); padding-left:15px;
      display:flex; align-items:center; justify-content:space-between; gap:18px;
    }

    /* Public teaser badge (shows only when war.active=true and NOT in secret mode) */
    #war-badge{
      display:none;
      font-size:10px;
      letter-spacing:2px;
      text-transform:uppercase;
      color:var(--red);
      border:1px solid rgba(255,68,68,.35);
      background:rgba(0,0,0,.25);
      padding:7px 10px;
      border-radius:999px;
      white-space:nowrap;
      user-select:none;
    }

    .grid{ display:grid; grid-template-columns:repeat(4,1fr); gap:20px; }
    .card{
      background:var(--card); padding:35px; border-radius:8px;
      border:1px solid #1f1f1f;
      transition:all .6s cubic-bezier(0.4,0,0.2,1);
      display:flex; flex-direction:column;
      position:relative;
      min-height:170px;
    }
    .card h3{
      font-size:10px; color:#555; text-transform:uppercase;
      margin:0 0 20px 0; letter-spacing:2px;
    }
    .primary-text{
      font-size:19px; font-weight:800; color:#fff; text-transform:uppercase;
      display:flex; align-items:center; gap:10px;
    }
    .secondary-text{
      font-size:11px; font-weight:700; margin-top:8px;
      text-transform:uppercase; letter-spacing:1px;
    }

    .halo-bg-gold{
      border-color: var(--gold) !important;
      background: linear-gradient(145deg, #111111 0%, #2a2210 100%) !important;
      box-shadow: 0 0 30px rgba(191,149,63,.15), inset 0 0 20px rgba(191,149,63,.10);
    }
    .halo-bg-silver{
      border-color: var(--silver) !important;
      background: linear-gradient(145deg, #111111 0%, #1a1a1a 100%) !important;
      box-shadow: 0 0 30px rgba(192,192,192,.15), inset 0 0 20px rgba(192,192,192,.08);
    }
    .glow-lime{
      border-color: var(--lime) !important;
      background: linear-gradient(145deg, #111111 0%, #0a1f0a 100%) !important;
      box-shadow: 0 0 26px rgba(50,205,50,.12), inset 0 0 22px rgba(50,205,50,.10);
    }
    .glow-warning{
      border-color: var(--orange) !important;
      background: linear-gradient(145deg, #111111 0%, #2a1a0a 100%) !important;
      box-shadow: 0 0 26px rgba(255,140,0,.12), inset 0 0 22px rgba(255,140,0,.10);
    }
    .glow-danger{
      border-color: var(--red) !important;
      background: linear-gradient(145deg, #111111 0%, #2a0a0a 100%) !important;
      box-shadow: 0 0 26px rgba(255,68,68,.14), inset 0 0 22px rgba(255,68,68,.12);
    }

    .halo-bg-secret{
      border-color: var(--secret) !important;
      background: linear-gradient(145deg, var(--secret-bg-1) 0%, var(--secret-bg-2) 100%) !important;
      box-shadow: 0 0 34px rgba(31,166,122,.22), inset 0 0 26px rgba(31,166,122,.18);
    }

    .track{ width:100%; height:4px; background:#1a1a1a; margin-top:18px; border-radius:2px; overflow:hidden; display:none; }
    .fill{ height:100%; width:0%; transition:1.2s; background:var(--gold); }

    .pulse-container{ display:flex; justify-content:center; align-items:center; padding:15px 0; flex-grow:1; }
    .pulse-node{ width:55px; height:55px; border-radius:50%; background:var(--dim); transition:.4s; }
    .pulse-slow{ animation:node-pulse 3s infinite ease-in-out; }
    .pulse-mid{ animation:node-pulse 1.2s infinite ease-in-out; }
    .pulse-fast{ animation:node-pulse .5s infinite ease-in-out; }
    @keyframes node-pulse{ 0%{transform:scale(.9);opacity:.5} 50%{transform:scale(1.1);opacity:1} 100%{transform:scale(.9);opacity:.5} }
    .recession-text{ font-size:12px !important; text-align:center; justify-content:center; margin-top:10px; }

    #password-modal{
      display:none; position:fixed; top:0; left:0; width:100%; height:100%;
      background:rgba(0,0,0,.95); z-index:10000;
      justify-content:center; align-items:center;
    }
    .modal-content{ background:#111; padding:30px; border:1px solid var(--gold); border-radius:4px; text-align:center; }
    .modal-input{
      background:#000; border:1px solid #333; color:#fff;
      padding:10px; width:200px; text-align:center;
      margin-bottom:20px; outline:none; font-family:monospace; letter-spacing:4px;
    }

    #vault-exit{
      display:none;
      margin-top:18px;
      padding:10px 14px;
      background:rgba(0,0,0,.25);
      border:1px solid rgba(31,166,122,.55);
      color:var(--secret);
      font-size:10px;
      letter-spacing:2px;
      text-transform:uppercase;
      cursor:pointer;
      border-radius:6px;
      width:fit-content;
      align-self:flex-start;
      transition:all .25s ease;
    }
    #vault-exit:hover{
      background:rgba(31,166,122,.08);
      box-shadow:0 0 18px rgba(31,166,122,.18);
    }

    /* Gauges */
    .gauge{
      margin-top:14px;
      display:flex;
      gap:10px;
      align-items:center;
    }
    .gauge-title{
      font-size:10px;
      color:#8a8a8a;
      letter-spacing:2px;
      text-transform:uppercase;
      min-width:120px;
      user-select:none;
    }
    .gauge-bars{
      display:grid;
      grid-template-columns:repeat(10, 1fr);
      gap:5px;
      width:100%;
    }
    .gseg{
      height:10px;
      border-radius:3px;
      background:var(--gseg-off);
      border:1px solid var(--gseg-off-b);
      transition:.25s;
    }
    .gmeta{
      margin-top:10px;
      font-size:10px;
      color:#8a8a8a;
      letter-spacing:1.4px;
      text-transform:uppercase;
      line-height:1.4;
    }
    .gmeta strong{ color:#fff; letter-spacing:1.2px; }

    /* ============================
       MONITORING STATE CARD
    ============================ */
    .section-header{
      font-size:14px; font-weight:700; color:#555;
      text-transform:uppercase; letter-spacing:4px;
      margin-bottom:-20px;
      border-left:3px solid var(--gold);
      padding-left:15px;
    }

    .card-wide{
      grid-column:1 / -1;
      min-height:180px;
    }

    .badge-row{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin-top:16px;
    }

    .badge{
      font-size:10px;
      letter-spacing:2px;
      text-transform:uppercase;
      padding:7px 12px;
      border-radius:999px;
      border:1px solid #2a2a2a;
      background:#0b0b0b;
      color:#cfcfcf;
    }

    .badge-good{
      border-color:rgba(50,205,50,.45);
      color:var(--lime);
    }
    .badge-warn{
      border-color:rgba(255,140,0,.45);
      color:var(--orange);
    }
    .badge-bad{
      border-color:rgba(255,68,68,.45);
      color:var(--red);
    }

    .mono{
      font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
    }
  </style>
</head>

<body>
   <div id="build-stamp"
     style="position:fixed;top:10px;left:10px;z-index:2147483647;
            font:16px monospace;background:#000;padding:6px 10px;
            border:2px solid #00ff66;color:#00ff66;">
  BUILD: RSC_VALIDATOR_V1
</div>

  <header class="header">
    <div class="logo-area">
      <img src="/static/logo.png" class="logo-img" alt="Logo" />
      <div style="width:1px;height:55px;background:#222;margin:0 20px;"></div>
      <div>
        <div style="display:flex;align-items:baseline;gap:10px;">
          <h1 class="gleam">SUTTON HOUSE</h1>
          <span style="color:#fff;font-size:16px;font-weight:300;letter-spacing:1px;text-transform:uppercase;">Market Analytics</span>
        </div>
        <div class="brand-bottom">MARKET MONITOR <div class="status-dot-active"></div> <span style="color:var(--lime);font-family:monospace;font-weight:bold;">TERMINAL ACTIVE</span></div>
      </div>
    </div>

    <div>
      <div id="digital-clock">00:00:00</div>
      <div class="city-grid">
        <div class="city-item" id="city-lon"><div class="status-dot"></div> LONDON</div>
        <div class="city-item" id="city-ny"><div class="status-dot"></div> NEW YORK</div>
        <div class="city-item" id="city-tor"><div class="status-dot"></div> TORONTO</div>
        <div class="city-item" id="city-syd"><div class="status-dot"></div> SYDNEY</div>
      </div>
    </div>
  </header>

  <div class="macro-header">
    <div>Macro Analysis</div>
    <div id="war-badge">WAR SIGNAL DETECTED — SECURE LAYER REQUIRED</div>
  </div>

  <button id="vault-exit" onclick="closeVault()">← Exit Secure Layer</button>

  <main class="grid">
    <div class="card" id="card-1">
      <h3 id="h3-1">Regime &amp; Volatility</h3>
      <div class="primary-text" id="val-1">AWAITING</div>
      <div class="secondary-text" id="sub-1"></div>
      <div id="gauge-1" style="display:none;"></div>
    </div>

    <div class="card" id="card-2">
      <h3 id="h3-2">Capital Rotation</h3>
      <div class="primary-text" id="val-2">AWAITING</div>
      <div class="secondary-text" id="sub-2"></div>
      <div class="gmeta" id="card2-meta" style="margin-top:14px;"></div>
      <div id="gauge-2" style="display:none;"></div>
    </div>

    <div class="card" id="card-3">
      <h3 id="h3-3">CYCLE CLOCK</h3>
      <div class="primary-text" id="val-3">AWAITING</div>
      <div class="secondary-text" id="sub-3"></div>
      <div class="track" id="track-3"><div class="fill" id="fill-3"></div></div>
      <div id="gauge-3" style="display:none;"></div>
    </div>

    <div class="card" id="card-4">
      <h3>Recession Pulse</h3>
      <div class="pulse-container"><div id="led-node" class="pulse-node"></div></div>
      <div class="primary-text recession-text" id="val-4">AWAITING</div>
      <div class="secondary-text" id="sub-4" style="display:none;"></div>
    </div>
  </main>

  <div class="section-header">Monitoring State</div>

  <main class="grid">
    <div class="card card-wide" id="monitor-card">
      <h3>Active Watch</h3>

      <div class="primary-text">
        <span class="mono" id="mon-ticker">NO SYMBOL</span>
        <span id="mon-trigger" class="badge">TRIGGER: —</span>
      </div>

      <div class="secondary-text" id="mon-status">
        AWAITING — NO ACTIVE MONITORING
      </div>

      <div class="badge-row">
        <div class="badge" id="mon-setup">SETUP: —</div>
        <div class="badge" id="mon-trend">TREND: —</div>
        <div class="badge" id="mon-strategy">STRATEGY: —</div>
        <div class="badge" id="mon-updated">UPDATED: —</div>
      </div>

      <div class="gmeta" style="margin-top:16px;">
        <strong>Note:</strong> Setup may persist for multiple days before confirmation.
      </div>
    </div>
  </main>

  <div id="password-modal">
    <div class="modal-content">
      <h2 style="color:var(--gold);font-size:10px;letter-spacing:3px;margin-bottom:20px;text-transform:uppercase;">Encryption Key Required</h2>
      <input type="password" id="pass-input" class="modal-input" placeholder="****" />
      <div style="display:flex;gap:10px;justify-content:center;">
        <button onclick="checkPass()" style="background:var(--gold);border:none;color:#000;padding:8px 15px;font-weight:bold;cursor:pointer;font-size:10px;">VERIFY</button>
        <button onclick="closeModal()" style="background:none;border:1px solid #333;color:#555;padding:8px 15px;cursor:pointer;font-size:10px;">ABORT</button>
      </div>
    </div>
  </div>

  <script>
    // ----------------------------
    // CLOCK
    // ----------------------------
    function tick(){
      const now = new Date();
      const clock = document.getElementById('digital-clock');
      if (clock) clock.innerText = now.toLocaleTimeString('en-GB', {hour12:false});

      const hrs = now.getUTCHours();
      const setCity = (id, open) => {
        const el = document.getElementById(id);
        if (el) el.className = open ? 'city-item city-open' : 'city-item';
      };

      setCity('city-lon', hrs >= 8 && hrs < 16);
      setCity('city-ny',  hrs >= 13 && hrs < 21);
      setCity('city-tor', hrs >= 13 && hrs < 21);
      setCity('city-syd', hrs >= 22 || hrs < 6);
    }
    tick();
    setInterval(tick, 1000);

    function triggerPulse(){
      document.querySelectorAll('.city-item').forEach(i => i.classList.add('comms-flash'));
      setTimeout(() => document.querySelectorAll('.city-item').forEach(i => i.classList.remove('comms-flash')), 400);
    }

    // ----------------------------
    // COLOR PALETTES (rhyme with Pine)
    // ----------------------------
    const XY_COL = {
      1:  'rgb(255, 6, 6)',
      2:  'rgb(252, 72, 0)',
      3:  'rgb(244, 106, 0)',
      4:  'rgb(230, 135, 0)',
      5:  'rgb(215, 159, 0)',
      6:  'rgb(197, 181, 0)',
      7:  'rgb(176, 200, 0)',
      8:  'rgb(149, 219, 0)',
      9:  'rgb(106, 238, 0)',
      10: 'rgb(0, 255, 26)',
    };

    const BUY_COL = {
      1:  'rgb(228, 250, 242)',
      2:  'rgb(175, 240, 217)',
      3:  'rgb(121, 230, 191)',
      4:  'rgb(67, 220, 165)',
      5:  'rgb(35, 188, 134)',
      6:  'rgb(25, 134, 95)',
      7:  'rgb(15, 80, 57)',
      8:  'rgb(5, 27, 19)',
      9:  'rgb(5, 27, 19)',
      10: 'rgb(5, 27, 19)',
    };

    const SELL_COL = {
      1:  'rgb(250, 228, 228)',
      2:  'rgb(240, 175, 175)',
      3:  'rgb(230, 121, 121)',
      4:  'rgb(220, 67, 67)',
      5:  'rgb(188, 35, 35)',
      6:  'rgb(134, 25, 25)',
      7:  'rgb(80, 15, 15)',
      8:  'rgb(27, 5, 5)',
      9:  'rgb(27, 5, 5)',
      10: 'rgb(27, 5, 5)',
    };

    function clampLevel(lv){
      const n = Number(lv);
      if (!Number.isFinite(n)) return null;
      return Math.max(0, Math.min(10, Math.round(n)));
    }

    function segStyle(color){
      return `background:${color};border-color:${color};box-shadow:0 0 12px rgba(255,255,255,.06);`;
    }

    function mkSingleBars(level, palette){
      const lv = clampLevel(level);
      let bars = '';
      for (let i=1;i<=10;i++){
        if (lv !== null && i <= lv){
          const col = palette[i] || palette[10] || 'rgba(31,166,122,.35)';
          bars += `<div class="gseg" style="${segStyle(col)}"></div>`;
        } else {
          bars += `<div class="gseg"></div>`;
        }
      }
      return bars;
    }

    function mkDualBars(level, palette){
      const lv = clampLevel(level) || 0;
      let bars = '';
      for (let i=1;i<=10;i++){
        if (i <= lv){
          const col = palette[i] || palette[10] || 'rgba(31,166,122,.35)';
          bars += `<div class="gseg" style="${segStyle(col)}"></div>`;
        } else {
          bars += `<div class="gseg"></div>`;
        }
      }
      return bars;
    }






    // ----------------------------
    // STATE CACHE
    // ----------------------------
    let lastState = null;

    function setText(id, txt){
      const el = document.getElementById(id);
      if (el) el.innerText = txt;
    }
    function _extract6mRor(flowRaw){
  // Looks for patterns like "6M ROR: 12.3%" or "6M RoR -1.2%" etc.
  if (!flowRaw) return null;
  const s = String(flowRaw);
  const m = s.match(/6M\s*R(?:O)?R\s*[:\-]?\s*([+\-]?\d+(\.\d+)?)\s*%/i);
  if (!m) return null;
  const v = parseFloat(m[1]);
  return Number.isFinite(v) ? v : null;
}

function _classifyRor(r){
  if (r === null) return 'UNKNOWN';
  if (r < 0) return 'NEGATIVE';
  if (r >= 0 && r <= 2) return 'FLAT';
  return 'RISING';
}

function _clockBucket(count){
  const c = parseInt(count, 10);
  if (!Number.isFinite(c)) return null;
  return (c <= 40) ? 'LOW' : 'HIGH';
}

function _card2Interpretation(rorClass, clockBucket){
  // If we don't have enough info, return a neutral "pending" state
  if (!clockBucket) return { label:'CYCLE CLOCK PENDING', tone:'', rule:'Waiting for Cycle Clock…' };
  if (rorClass === 'UNKNOWN') return { label:'6M RoR PENDING', tone:'', rule:'Waiting for 6M RoR…' };

  // Your table — now returns the matching rule line only
  if (rorClass === 'RISING' && clockBucket === 'LOW')
    return { label:'TREND CONFIRMATION', tone:'badge-good', rule:'Rising RoR + Low clock → trend confirmation.' };

  if (rorClass === 'FLAT' && clockBucket === 'LOW')
    return { label:'OPPORTUNITY / CONSOLIDATION', tone:'badge-warn', rule:'Flat/slowing RoR + Low clock → consolidation / opportunity.' };

  if (rorClass === 'NEGATIVE' && clockBucket === 'HIGH')
    return { label:'DISTRIBUTION RISK', tone:'badge-bad', rule:'Negative RoR + High clock → distribution risk.' };

  if (rorClass === 'FLAT' && clockBucket === 'HIGH')
    return { label:'LATE CYCLE WARNING', tone:'badge-warn', rule:'Flat/slowing RoR + High clock → late-cycle warning.' };

  if (rorClass === 'RISING' && clockBucket === 'HIGH')
    return { label:'LATE CYCLE — WATCH', tone:'badge-warn', rule:'Rising RoR + High clock → strong trend, but late-cycle watch.' };

  // If you still use MID
  if (clockBucket === 'MID'){
    if (rorClass === 'RISING')   return { label:'TREND HEALTHY', tone:'badge-good', rule:'Rising RoR + Mid clock → trend healthy.' };
    if (rorClass === 'FLAT')     return { label:'PAUSE / DIGESTION', tone:'badge-warn', rule:'Flat RoR + Mid clock → pause / digestion.' };
    if (rorClass === 'NEGATIVE') return { label:'RISK RISING', tone:'badge-bad', rule:'Negative RoR + Mid clock → risk rising.' };
  }

  return { label:'CONTEXT ACTIVE', tone:'', rule:'Context active.' };
}

function _renderCard2Meta(flowRaw, count){
  const host = document.getElementById('card2-meta');
  if (!host) return;

  const r = _extract6mRor(flowRaw);
  const rClass = _classifyRor(r);

  const cb = _clockBucket(count);
  const out = _card2Interpretation(rClass, cb);

  const rTxt = (r === null) ? '—' : (r.toFixed(2) + '%');
  const cVal = parseInt(count, 10);
  const cTxt = Number.isFinite(cVal) ? (cVal + '%') : '—';

  const pill = out.tone
    ? `<span class="badge ${out.tone}">${out.label}</span>`
    : `<span class="badge">${out.label}</span>`;

  host.innerHTML = `
    <div><strong>6M RoR:</strong> ${rTxt} &nbsp; <strong>CYCLE CLOCK:</strong> ${cTxt}</div>
    <div style="margin-top:10px;">${pill}</div>
    <div style="margin-top:10px;opacity:.85;">${out.rule || ''}</div>
  `;
}
    function hideGauge(containerId){
      const host = document.getElementById(containerId);
      if (host){ host.style.display = 'none'; host.innerHTML = ''; }
    }

    function showGauge(containerId, level, title, metaLines, palette){
      const host = document.getElementById(containerId);
      if (!host) return;

      const bars = mkSingleBars(level, palette || XY_COL);

      let metaHtml = '';
      if (Array.isArray(metaLines) && metaLines.length){
        metaHtml = `<div class="gmeta">${metaLines.map(x => `<div>${x}</div>`).join('')}</div>`;
      }

      host.innerHTML = `
        <div class="gauge">
          <div class="gauge-title">${title}</div>
          <div class="gauge-bars">${bars}</div>
        </div>
        ${metaHtml}
      `;
      host.style.display = 'block';
    }

    function showDualGauge(containerId, buyLevel, sellLevel, title, metaLines){
      const host = document.getElementById(containerId);
      if (!host) return;

      const buyBars  = mkDualBars(buyLevel, BUY_COL);
      const sellBars = mkDualBars(sellLevel, SELL_COL);

      const metaHtml = Array.isArray(metaLines) && metaLines.length
        ? `<div class="gmeta">${metaLines.map(x => `<div>${x}</div>`).join('')}</div>`
        : '';

      host.innerHTML = `
        <div class="gauge">
          <div class="gauge-title">${title}</div>
          <div style="width:100%;">
            <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;">
              <div style="min-width:42px;font-size:10px;color:#8a8a8a;letter-spacing:2px;text-transform:uppercase;">BUY</div>
              <div class="gauge-bars">${buyBars}</div>
            </div>
            <div style="display:flex;align-items:center;gap:10px;">
              <div style="min-width:42px;font-size:10px;color:#8a8a8a;letter-spacing:2px;text-transform:uppercase;">SELL</div>
              <div class="gauge-bars">${sellBars}</div>
            </div>
          </div>
        </div>
        ${metaHtml}
      `;
      host.style.display = 'block';
    }

    // ----------------------------
    // SECRET MODE
    // ----------------------------
    let secretMode = false;

    function enableSecretMode(){
      secretMode = true;

      const exitBtn = document.getElementById('vault-exit');
      if (exitBtn) exitBtn.style.display = 'inline-flex';

      setText('h3-1', 'Institutional X');
      setText('h3-2', 'Institutional Y');
      setText('h3-3', 'Institutional Buyers / Sellers');

      ['card-1','card-2','card-3'].forEach(id => {
        const c = document.getElementById(id);
        if (c) c.className = 'card halo-bg-secret';
      });

      const t3 = document.getElementById('track-3');
      if (t3) t3.style.display = 'none';

      if (lastState) applySecretFromState(lastState);
    }

    function closeVault(){
      secretMode = false;

      const exitBtn = document.getElementById('vault-exit');
      if (exitBtn) exitBtn.style.display = 'none';

      hideGauge('gauge-1');
      hideGauge('gauge-2');
      hideGauge('gauge-3');

      setText('h3-1', 'Regime & Volatility');
      setText('h3-2', 'Capital Rotation');
      setText('h3-3', 'CYCLE CLOCK');

      if (lastState) applyPublicFromState(lastState);
      else applyPublicFromState({});
    }
    window.closeVault = closeVault;

    function setWarBadge(active){
      const badge = document.getElementById('war-badge');
      if (!badge) return;
      badge.style.display = (!secretMode && active) ? 'inline-flex' : 'none';
    }

    // ----------------------------
    // PUBLIC APPLY
    // ----------------------------
    function applyPublicFromState(data){
      const warActive = !!(data && data.secret && data.secret.war && data.secret.war.active);

      document.body.classList.toggle('war-room', warActive);
      setWarBadge(warActive);

      ['card-1','card-2','card-3'].forEach(id => {
        const c = document.getElementById(id);
        if (c) c.className = 'card';
      });
      setText('val-1', 'AWAITING'); setText('sub-1','');
      setText('val-2', 'AWAITING'); setText('sub-2','');
      setText('val-3', 'AWAITING'); setText('sub-3','');

      const t3 = document.getElementById('track-3');
      const f3 = document.getElementById('fill-3');
      if (t3) t3.style.display = 'none';
      if (f3) f3.style.width = '0%';

      // Card 1
      if (data && data.cycle){
        const v1 = document.getElementById('val-1');
        const c1 = document.getElementById('card-1');
        const isCom = String(data.cycle).toLowerCase().includes('commodities');
        if (v1){
          v1.innerText = isCom ? 'STRONG COMMODITIES MACRO' : String(data.cycle).toUpperCase();
          v1.style.color = isCom ? 'var(--gold)' : 'var(--text)';
        }
        if (c1) c1.className = isCom ? 'card halo-bg-gold' : 'card halo-bg-silver';
      }

      if (data && data.vol){
        const s1 = document.getElementById('sub-1');
        if (s1){
          s1.innerText = 'VOLATILITY: ' + String(data.vol).toUpperCase();
          s1.style.color = (String(data.vol).toUpperCase() === 'ELEVATED') ? 'var(--red)' : 'var(--lime)';
        }
      }

      // Card 2 (MOD: bulletproof + always show a detail line)
if (data && data.flow !== undefined && data.flow !== null){
  const v2 = document.getElementById('val-2');
  const s2 = document.getElementById('sub-2');
  const c2 = document.getElementById('card-2');

  const flowRaw = String(data.flow || '').trim();

  const parts = flowRaw
    .split('|')
    .map(x => (x || '').trim())
    .filter(x => x.length > 0);

  const headline = (parts.length >= 1 ? parts[0] : 'ROTATION ACTIVE').trim();

  let detail = '';
  if (parts.length >= 2) {
    detail = parts.slice(1).join(' | ').trim();
  } else {
    detail = (flowRaw.toUpperCase() === headline.toUpperCase()) ? '' : flowRaw;
  }

  const intoCom = flowRaw.toLowerCase().includes('into commodities');
  const intoEq  = flowRaw.toLowerCase().includes('into equities');

  const cycleStr = String(data.cycle || '').toLowerCase();
  const isComCycle = cycleStr.includes('commod');
  const makeGold = intoCom || isComCycle;

  if (v2){
    v2.innerText = headline.toUpperCase();
    v2.style.color = makeGold ? 'var(--gold)' : (intoEq ? 'var(--silver)' : 'var(--text)');
  }

  if (s2){
    const fallback = makeGold ? 'OUT OF EQUITIES → INTO COMMODITIES' : 'ROTATION ACTIVE';
    s2.innerText = (detail && detail.length) ? detail.toUpperCase() : fallback;
    s2.style.color = 'var(--text)';
    s2.style.display = 'block';
  }

  if (c2) c2.className = makeGold ? 'card halo-bg-gold' : 'card halo-bg-silver';

  // Render the RoR/Clock interpretation panel
  _renderCard2Meta(flowRaw, data ? data.count : null);


} else {
  // If flow is missing, still render the panel in neutral "awaiting" state
  _renderCard2Meta(null, data ? data.count : null);
}

      // Card 3 maturity
      if (data && data.count !== undefined && data.count !== null){
        const count = Number.parseInt(data.count, 10);

        const v3 = document.getElementById('val-3');
        const s3 = document.getElementById('sub-3');
        const c3 = document.getElementById('card-3');
        const t3 = document.getElementById('track-3');
        const f3 = document.getElementById('fill-3');

        if (Number.isFinite(count)){
          if (t3) t3.style.display = 'block';
          if (f3) f3.style.width = count + '%';
          if (s3) s3.innerText = 'MATURITY: ' + count + '%';

          const cycleStr = String(data.cycle || '').toLowerCase();
          const isCommodities = cycleStr.includes('commod');

          if (count <= 0){
            if (v3){ v3.innerText = 'INITIATING'; v3.style.color = 'var(--dim)'; }
            if (c3) c3.className = 'card';
            if (f3) f3.style.background = 'var(--dim)';
          } else if (count <= 25){
            if (v3){ v3.innerText = 'EARLY CYCLE'; v3.style.color = 'var(--lime)'; }
            if (c3) c3.className = 'card glow-lime';
            if (f3) f3.style.background = 'var(--lime)';
          } else if (count <= 70){
            if (v3) v3.innerText = 'ESTABLISHED CYCLE';
            if (v3) v3.style.color = isCommodities ? 'var(--gold)' : 'var(--silver)';
            if (c3) c3.className = isCommodities ? 'card halo-bg-gold' : 'card halo-bg-silver';
            if (f3) f3.style.background = isCommodities ? 'var(--gold)' : 'var(--silver)';
          } else {
            const endCol = (count > 85) ? 'var(--red)' : 'var(--orange)';
            if (v3){ v3.innerText = 'CYCLE END APPROACHING'; v3.style.color = endCol; }
            if (c3) c3.className = (count > 85) ? 'card glow-danger' : 'card glow-warning';
            if (f3) f3.style.background = endCol;
          }
        }
      }
    }

    // ----------------------------
    // SECRET APPLY (unchanged)
    // ----------------------------
    function applySecretFromState(data){
      const secret = (data && data.secret) ? data.secret : {};
      const vix = secret.vix || {};
      const gvz = secret.gvz || {};
      const buy = secret.buy || {};
      const sell = secret.sell || {};
      const vold = secret.vold || {};
      const warActive = !!(secret && secret.war && secret.war.active);

      document.body.classList.toggle('war-room', warActive);
      setWarBadge(false);

      const v1 = document.getElementById('val-1');
      const s1 = document.getElementById('sub-1');
      const v2 = document.getElementById('val-2');
      const s2 = document.getElementById('sub-2');
      const v3 = document.getElementById('val-3');
      const s3 = document.getElementById('sub-3');

      const xVal = (vix.value !== null && vix.value !== undefined) ? (String(vix.value) + '%') : '—';
      setText('val-1', xVal);
      setText('sub-1', vix.state ? vix.state : 'AWAITING SIGNAL');
      if (v1) v1.style.color = 'var(--text)';
      if (s1) s1.style.color = 'var(--text)';

      showGauge(
        'gauge-1',
        vix.level,
        'LEVEL',
        [
          `<strong>Institutional X</strong>`,
          `LEVEL: ${vix.level ?? '—'}${(vix.level && vix.level <= 4) ? ' • WAR ROOM' : ''}`
        ],
        XY_COL
      );

      const yVal = (gvz.value !== null && gvz.value !== undefined) ? (String(gvz.value) + '%') : '—';
      setText('val-2', yVal);
      setText('sub-2', gvz.state ? gvz.state : 'AWAITING SIGNAL');
      if (v2) v2.style.color = 'var(--text)';
      if (s2) s2.style.color = 'var(--text)';

      showGauge(
        'gauge-2',
        gvz.level,
        'LEVEL',
        [
          `<strong>Institutional Y</strong>`,
          `LEVEL: ${gvz.level ?? '—'}${(gvz.level && (gvz.level <= 3 || gvz.level >= 8)) ? ' • WAR ROOM' : ''}`
        ],
        XY_COL
      );

      const buyVal = (buy.value !== null && buy.value !== undefined) ? String(buy.value) : '—';
      const sellVal = (sell.value !== null && sell.value !== undefined) ? String(sell.value) : '—';

      setText('val-3', `BUY ${buyVal} / SELL ${sellVal}`);
      setText('sub-3', `${(buy.state || 'BUYING')} • ${(sell.state || 'SELLING')}${vold.state ? (' • ' + vold.state) : ''}`.trim());
      if (v3) v3.style.color = 'var(--text)';
      if (s3) s3.style.color = 'var(--text)';

      const buyL  = Number.isFinite(buy.level) ? buy.level : 0;
      const sellL = Number.isFinite(sell.level) ? sell.level : 0;

      showDualGauge(
        'gauge-3',
        buyL,
        sellL,
        'PRESSURE',
        [
          `<strong>Institutional Buyers / Sellers</strong>`,
          `BUY_L: ${buy.level ?? '—'} • SELL_L: ${sell.level ?? '—'}`
        ]
      );
    }

    // ----------------------------
    // MONITORING STATE APPLY (unchanged)
    // ----------------------------
    function applyMonitoringFromState(data){
      const m = data && data.monitor ? data.monitor : {};

      const ticker   = (m.ticker || '').toUpperCase();
      const trigger  = (m.trigger || '').toUpperCase();
      const status   = m.status || '';
      const setup    = m.setup;
      const trend    = (m.trend || '').toUpperCase();
      const strategy = (m.strategy || '').toUpperCase();
      const updated  = m.updated || '';

      const tickerEl = document.getElementById('mon-ticker');
      const trigEl   = document.getElementById('mon-trigger');
      const statusEl = document.getElementById('mon-status');

      if (tickerEl) tickerEl.innerText = ticker || 'NO SYMBOL';
      if (trigEl)   trigEl.innerText   = `TRIGGER: ${trigger || '—'}`;
      if (statusEl) statusEl.innerText = status || 'AWAITING — NO ACTIVE MONITORING';

      const setupEl = document.getElementById('mon-setup');
      if (setupEl){
        setupEl.className = 'badge';
        if (setup === true || setup === 'ON'){
          setupEl.classList.add('badge-warn');
          setupEl.innerText = 'SETUP: ACTIVE';
        } else {
          setupEl.innerText = 'SETUP: INACTIVE';
        }
      }

      const trendEl = document.getElementById('mon-trend');
      if (trendEl){
        trendEl.className = 'badge';
        if (trend === 'ALIGNED'){
          trendEl.classList.add('badge-good');
          trendEl.innerText = 'TREND: ALIGNED';
        } else if (trend === 'MISALIGNED'){
          trendEl.classList.add('badge-bad');
          trendEl.innerText = 'TREND: MISALIGNED';
        } else {
          trendEl.innerText = 'TREND: —';
        }
      }

      const stratEl = document.getElementById('mon-strategy');
      if (stratEl){
        stratEl.className = 'badge';
        stratEl.innerText = `STRATEGY: ${strategy || '—'}`;
      }

      const updEl = document.getElementById('mon-updated');
      if (updEl){
        updEl.innerText = `UPDATED: ${updated || '—'}`;
      }

      const card = document.getElementById('monitor-card');
      if (card){
        card.className = 'card card-wide';
        const setupOn = (setup === true || setup === 'ON');
        if (setupOn && trend === 'ALIGNED') card.classList.add('glow-lime');
        if (trend === 'MISALIGNED') card.classList.add('glow-danger');
        if (setupOn && trend !== 'ALIGNED') card.classList.add('glow-warning');
      }
    }
<script>
/* === RSC MOCK MODE (REMOVE LATER) === */
window.RSC_MOCK = true;

function emitMockMacro(payload){
  if(!window.RSC_MOCK) return;
  console.log("[RSC MOCK]", payload);
  window.handleMacroUpdate(payload);
}
</script>

    // ----------------------------
    // SOCKET.IO
    // ----------------------------
    let socket = null;
    try{
      if (window.io){
        socket = io({ transports:['polling','websocket'], upgrade:true, reconnection:true });
        socket.on('connect', () => console.log('CONNECTED'));
        socket.on('connect_error', (e) => console.log('SOCKET ERROR', e));
      } else {
        console.log('Socket.IO not loaded; clock will still run.');
      }
    } catch(e){
      console.log('Socket init failed; clock will still run.', e);
    }

  // ============================================================
  // APPLY ALL (PAINT)
  // ============================================================
  function applyAllFromState(data){
    lastState = data || {};

    const warActive = !!(data && data.secret && data.secret.war && data.secret.war.active);
    setWarBadge(warActive);

    if (!secretMode) applyPublicFromState(data);
    else applySecretFromState(data);

    applyMonitoringFromState(data);

    if (data && data.sahm !== undefined && data.sahm !== null){
      const s = parseFloat(data.sahm) || 0;
      const v4 = document.getElementById('val-4');
      const c4 = document.getElementById('card-4');
      const node = document.getElementById('led-node');

      if (s <= 0.34){
        if (v4) v4.innerText = 'EXPANSION PHASE';
        if (c4) c4.className = 'card glow-lime';
        if (node){
          node.className = 'pulse-node pulse-slow';
          node.style.background = 'var(--lime)';
          node.style.boxShadow = '0 0 40px var(--lime)';
        }
      } else if (s <= 0.49){
        if (v4) v4.innerText = 'WARNING: ECONOMY STALLING';
        if (c4) c4.className = 'card glow-warning';
        if (node){
          node.className = 'pulse-node pulse-mid';
          node.style.background = 'var(--orange)';
          node.style.boxShadow = '0 0 40px var(--orange)';
        }
      } else {
        if (v4) v4.innerText = 'CONTRACTION';
        if (c4) c4.className = 'card glow-danger';
        if (node){
          node.className = 'pulse-node pulse-fast';
          node.style.background = 'var(--red)';
          node.style.boxShadow = '0 0 60px var(--red)';
        }
      }
    }
  }
  window.applyAllFromState = applyAllFromState; // ensures entry-point can see it

  // ============================================================
  // ROUTE ALL LIVE DATA THROUGH ENTRY POINT
  // ============================================================
  if (socket){
    socket.on('macro_update', (data) => {
      triggerPulse();
      if (typeof window.handleMacroUpdate === "function") {
        window.handleMacroUpdate(data);
      } else {
        console.warn("[RSC WARN] handleMacroUpdate missing — fallback paint");
        applyAllFromState(data);
      }
    });
  }

  // ============================================================
  // WARM START (HEALTH)
  // ============================================================
  (async function warmStart(){
    try{
      const r = await fetch('/health', { cache:'no-store' });
      if (!r.ok) return;
      const j = await r.json();
      if (j && j.state){
        if (typeof window.handleMacroUpdate === "function") window.handleMacroUpdate(j.state);
        else applyAllFromState(j.state);
      }
    } catch(e){}
  })();

  // ============================================================
  // PASSWORD MODAL
  // ============================================================
  const tor = document.getElementById('city-tor');
  if (tor){
    tor.addEventListener('dblclick', () => {
      const modal = document.getElementById('password-modal');
      const input = document.getElementById('pass-input');
      if (modal) modal.style.display = 'flex';
      if (input) input.focus();
    });
  }

  function closeModal(){
    const modal = document.getElementById('password-modal');
    const input = document.getElementById('pass-input');
    if (modal) modal.style.display = 'none';
    if (input) input.value = '';
  }
  window.closeModal = closeModal;

  async function checkPass(){
    const input = document.getElementById('pass-input');
    const pwd = input ? input.value : '';

    try{
      const r = await fetch('/verify_secret', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ password: pwd })
      });
      closeModal();
      if (r.ok) enableSecretMode();
    } catch(e){
      closeModal();
    }
  }
  window.checkPass = checkPass;

  const passInput = document.getElementById('pass-input');
  if (passInput){
    passInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') checkPass();
    });
  }
</script>
</body>
</html>

